<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"controllers_affiliates_affiliates.controller.js.html":{"id":"controllers_affiliates_affiliates.controller.js.html","title":"Source: controllers/affiliates/affiliates.controller.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: controllers/affiliates/affiliates.controller.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../../components&quot;); const base_controller_1 = require(&quot;../base.controller&quot;); const objKeyValidator_1 = require(&quot;../../validators/objKeyValidator&quot;); /** * @desc Controller of the REST API logic for Affiliates * * @export * @class AffiliatesController * @extends {BaseController} */ let AffiliatesController = class AffiliatesController extends base_controller_1.BaseController { constructor(affService, logger) { super(logger); this.affService = affService; } ; /** * @desc &lt;h5&gt;GET: /affiliates&lt;/h5&gt; Calls {@link AffiliatesService#getAll} to get a list of affiliates * * @param {Query} isPublicQ - Query parameter &lt;code&gt;'isPublic'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Alias &lt;code&gt;headers['x-force-refesh']&lt;/code&gt;; Returns public affiliates * @param {Header} isPublicH - Header &lt;code&gt;'x-is-public'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Alias &lt;code&gt;query['isPublic']&lt;/code&gt;; Returns public affiliates * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ readAll(res, session, isPublicQ, isPublicH, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { const isPublic = (isPublicQ === 'true' || isPublicH === 'true'); const forceRefresh = refresh === 'true'; if (!isPublic &amp;&amp; (!session.user || session.user.role.name !== 'Affiliate Manager')) return this.handleError(res, 'Error in AffiliatesController.readAll(): ', { error: 'NOT_AFFILIATE_MANAGER' }, common_1.HttpStatus.FORBIDDEN); try { const affiliates = yield this.affService.getAll(isPublic, forceRefresh); return res.status(common_1.HttpStatus.OK).json(affiliates); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.readAll(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /affiliates/describe&lt;/h5&gt; Calls {@link AffiliatesService#describe} to describe the Account Object * * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ describe(res, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { try { const describeObject = yield this.affService.describe(refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(describeObject); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.describe(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /affiliates/search&lt;/h5&gt; Calls {@link AffiliatesService#search}. Returns an array of affiliates that match search criteria * * @param {Header} search - Header &lt;code&gt;'x-search'&lt;/code&gt;. SOSL search expression (i.e. '*Test*'). * @param {Header} retrieve - Header &lt;code&gt;'x-retrieve'&lt;/code&gt;. A comma seperated list of the Account fields to retrieve (i.e. 'Id, Name') * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ search(res, search, retrieve, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { // Check for required fields if (!search || !retrieve) return this.handleError(res, 'Error in AffiliatesController.search(): ', { error: 'MISSING_PARAMETERS', params: (!search &amp;&amp; !retrieve ? ['search', 'retrieve '] : !search ? ['search'] : ['retrieve']) }, common_1.HttpStatus.BAD_REQUEST); try { const affiliates = yield this.affService.search(search, retrieve, refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(affiliates); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.search(): ', error); } }); } /** * Search the related contacts of an Affiliate. Calls {@link AffiliatesService#searchCM} to retrieve a list of contacts * * @param {SalesforceId} id - The Salesforce Id of the affiliate * @param {Header} search - Header &lt;code&gt;'x-search'&lt;/code&gt;. SOSL search expression (i.e. 'User*'). * @param {Header} retrieve - Header &lt;code&gt;'x-retrieve'&lt;/code&gt;. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name') * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ searchCMS(res, id, search, retrieve, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in AffiliatesController.searchCMS(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); if (!search || !retrieve) return this.handleError(res, 'Error in AffiliatesController.searchCMS(): ', { error: 'MISSING_PARAMETERS', params: (!search &amp;&amp; !retrieve ? ['search', 'retrieve '] : !search ? ['search'] : ['retrieve']) }, common_1.HttpStatus.BAD_REQUEST); try { const cms = yield this.affService.searchCM(id, search, retrieve, refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(cms); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.searchCMS(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /affiliates/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link AffiliatesService#get} to retrieve a specific affiliate * * @param {SalesforceId} id - Account id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ read(res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in AffiliatesController.read(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const affiliate = yield this.affService.get(id); return res.status(common_1.HttpStatus.OK).json(affiliate); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.read(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /affiliates&lt;/h5&gt; Calls {@link AffiliatesService#create} to create a new Affiliate * * @param {Body} body - Required fields &lt;code&gt;[ &quot;Name&quot; ]&lt;/code&gt; * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ create(res, body) { return __awaiter(this, void 0, void 0, function* () { const required = objKeyValidator_1.checkRequired(body, ['Name']); if (!required.valid) return this.handleError(res, 'Error in AffiliatesController.create(): ', { error: 'MISSING_FIELDS', fields: required.missing }, common_1.HttpStatus.BAD_REQUEST); try { const sfSuccess = yield this.affService.create(body); return res.status(common_1.HttpStatus.CREATED).json(sfSuccess); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.create(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /affiliates/&lt;em&gt;:id&lt;/em&gt;/map&lt;/h5&gt; Calls {@link AffiliatesService#map} to create permissions for a Licensed Affiliate Account * * @param {SalesforceId} id - Account id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ map(res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in AffiliatesController.map(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { yield this.affService.map(id); return res.status(common_1.HttpStatus.OK).json({ mapped: true }); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.map(): ', error); } }); } /** * @desc &lt;h5&gt;PUT: /affiliates/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link AffiliatesService#update} to update an Affiliate * * @param {Body} body - Required fields &lt;code&gt;[ &quot;Id&quot; ]&lt;/code&gt; * @param {SalesforceId} id - Account id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ update(res, body, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/) || id !== body.Id) return this.handleError(res, 'Error in AffiliatesController.update(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); let required = objKeyValidator_1.checkRequired(body, ['Id']); if (!required.valid) return this.handleError(res, 'Error in AffiliatesController.update(): ', { error: &quot;MISSING_FIELDS&quot;, fields: required.missing }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.affService.update(body); return res.status(common_1.HttpStatus.OK).json(result); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.update(): ', error); } }); } /** * @desc &lt;h5&gt;DELETE: /affiliates/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link AffiliatesService#delete} to &quot;delete&quot; an Affiliate * * @param {SalesforceId} id - Account id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} * @memberof AffiliatesController */ delete(res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in AffiliatesController.delete(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.affService.delete(id); return res.status(common_1.HttpStatus.OK).json(result); } catch (error) { return this.handleError(res, 'Error in AffiliatesController.delete(): ', error); } }); } }; __decorate([ common_1.Get(), __param(0, common_1.Response()), __param(1, common_1.Session()), __param(2, common_1.Query('isPublic')), __param(3, common_1.Headers('x-is-public')), __param(4, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;readAll&quot;, null); __decorate([ common_1.Get('/describe'), __param(0, common_1.Response()), __param(1, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;describe&quot;, null); __decorate([ common_1.Get('/search'), __param(0, common_1.Response()), __param(1, common_1.Headers('x-search')), __param(2, common_1.Headers('x-retrieve')), __param(3, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;search&quot;, null); __decorate([ common_1.Get('/:id/coursemanagers'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __param(2, common_1.Headers('x-search')), __param(3, common_1.Headers('x-retrieve')), __param(4, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;searchCMS&quot;, null); __decorate([ common_1.Get(':id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;read&quot;, null); __decorate([ common_1.Post(), __param(0, common_1.Response()), __param(1, common_1.Body()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;create&quot;, null); __decorate([ common_1.Post(':id/map'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;map&quot;, null); __decorate([ common_1.Put(':id'), __param(0, common_1.Response()), __param(1, common_1.Body()), __param(2, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;update&quot;, null); __decorate([ common_1.Delete(':id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AffiliatesController.prototype, &quot;delete&quot;, null); AffiliatesController = __decorate([ common_1.Controller('affiliates'), __metadata(&quot;design:paramtypes&quot;, [components_1.AffiliatesService, components_1.LoggerService]) ], AffiliatesController); exports.AffiliatesController = AffiliatesController; × Search results Close "},"controllers_base.controller.js.html":{"id":"controllers_base.controller.js.html","title":"Source: controllers/base.controller.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: controllers/base.controller.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../components&quot;); /** * @desc The base controller class contains methods shared between multiple routes * * @export * @class BaseController */ class BaseController { constructor(log) { this.log = log; } ; /** * @desc A helper function to return an error response to the client. * * @param {Response} res - The express response from the calling route * @param {string} message - Log message * @param {*} error - An error object to be logged and returned as JSON * @param {HttpStatus} [errorCode=HttpStatus.INTERNAL_SERVER_ERROR] - HttpStatus CODE * @returns Response body is a JSON object with the error * @memberof BaseController */ handleError(res, message, error, errorCode = common_1.HttpStatus.INTERNAL_SERVER_ERROR) { if (error.metadata) error = components_1.SalesforceService.parseRPCErrorMeta(error); if (error.message) error = { message: error.message }; this.log.error(message + ' %j', error); return res.status(errorCode).json({ error }); } } __decorate([ __param(0, common_1.Response()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, String, Object, Number]), __metadata(&quot;design:returntype&quot;, void 0) ], BaseController.prototype, &quot;handleError&quot;, null); exports.BaseController = BaseController; × Search results Close "},"components_affiliates_affiliates.component.js.html":{"id":"components_affiliates_affiliates.component.js.html","title":"Source: components/affiliates/affiliates.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/affiliates/affiliates.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const _1 = require(&quot;../&quot;); /** * @desc A service to provide functions for working with Affiliates * * @export * @class AffiliatesService */ let AffiliatesService = class AffiliatesService { constructor(sfService = new _1.SalesforceService(), authService = new _1.AuthService(), cache = new _1.CacheService(), log = new _1.LoggerService()) { this.sfService = sfService; this.authService = authService; this.cache = cache; this.log = log; } /** * @desc Get all AFfiliates (minus McKinsey if &lt;code&gt;isPublic&lt;/code&gt;). Queries the following fields:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;&quot;Id&quot;,&lt;br&gt; * &amp;emsp;&quot;Name&quot;,&lt;br&gt; * &amp;emsp;&quot;Summary__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Logo__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Page_Path__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Website&quot;,&lt;br&gt; * &amp;emsp;&quot;Languages__c&quot;&lt;br&gt; * ]&lt;/code&gt; * * @param {boolean} [isPublic=false] - Filter out private Affiliates * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;Affiliate[]&gt;} * @memberof AffiliatesService */ getAll(isPublic = false, refresh = false) { return __awaiter(this, void 0, void 0, function* () { const query = { action: &quot;SELECT&quot;, fields: [ &quot;Id&quot;, &quot;Name&quot;, &quot;Summary__c&quot;, &quot;Logo__c&quot;, &quot;Page_Path__c&quot;, &quot;Website&quot;, &quot;Languages__c&quot; ], table: &quot;Account&quot;, clauses: &quot;RecordType.Name='Licensed Affiliate'&quot; }; if (!isPublic) query.clauses += &quot; AND (NOT Name LIKE 'McKinsey%')&quot;; if (!this.cache.isCached(query) || refresh) { const affiliates = (yield this.sfService.query(query)).records; if (isPublic) this.cache.cache(query, affiliates); return Promise.resolve(affiliates); } else { return Promise.resolve(this.cache.getCache(query)); } }); } /** * @desc Get the facilitator with the id passed at the parameter :id. The following fields are returned:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * TODO: Add fields that are returned&lt;br&gt; * ]&lt;/code&gt; * * @param {string} id - Salesforce ID for an Account * @returns {Promise&lt;Affiliate&gt;} * @memberof AffiliatesService */ get(id) { return __awaiter(this, void 0, void 0, function* () { const affiliate = (yield this.sfService.retrieve({ object: 'Account', ids: [id] }))[0]; return Promise.resolve(affiliate); }); } /** * @desc Uses the Salesforce REST API to describe the Account object. See the Salesforce documentation for more about 'describe' * * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;any&gt;} * @memberof AffiliatesService */ describe(refresh = false) { return __awaiter(this, void 0, void 0, function* () { // Set the key for the cache const key = 'describeAccounts'; // If no cached result, use the shingo-sf-api to get the result if (!this.cache.isCached(key) || refresh) { const describeObject = yield this.sfService.describe('Account'); // Cache describe this.cache.cache(key, describeObject); return Promise.resolve(describeObject); } else { return Promise.resolve(this.cache.getCache(key)); } }); } /** * @desc Executes a SOSL query to search for text on Accounts of record type Licensed Affiliate. Example response body:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZAAZ&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test One&quot;,&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZABA&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Two&quot;,&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZABB&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Three&quot;,&lt;br&gt; * &amp;emsp;},&lt;br&gt; * ]&lt;/code&gt; * * @param {Header} search - Header 'x-search'. SOSL search expression (i.e. '*Test*'). * @param {Header} retrieve - Header 'x-retrieve'. A comma seperated list of the Account fields to retrieve (i.e. 'Id, Name') * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;Affiliate[]&gt;} * @memberof AffiliatesService */ search(search, retrieve, refresh = false) { return __awaiter(this, void 0, void 0, function* () { if (!retrieve.includes('RecordType.Name')) retrieve += ', RecordType.Name'; // Generate the data parameter for the RPC call const data = { search: `{${search}}`, retrieve: `Account(${retrieve})` }; // If no cached result, use the shingo-sf-api to get result if (!this.cache.isCached(data) || refresh) { let affiliates = (yield this.sfService.search(data)).searchRecords || []; affiliates = affiliates.filter(aff =&gt; { return aff.RecordType.Name === 'Licensed Affiliate'; }); // Cache results this.cache.cache(data, affiliates); return Promise.resolve(affiliates); } else { return Promise.resolve(this.cache.getCache(data)); } }); } searchCM(id, search, retrieve, refresh = false) { return __awaiter(this, void 0, void 0, function* () { if (!retrieve.includes('AccountId')) retrieve += ', AccountId'; const data = { search: `{${search}}`, retrieve: `Contact(${retrieve})` }; if (!this.cache.isCached(data) || refresh) { let cms = (yield this.sfService.search(data)).searchRecords || []; cms = cms.filter(cm =&gt; { return cm.AccountId === id; }); this.cache.cache(data, cms); return Promise.resolve(cms); } else { return Promise.resolve(this.cache.getCache(data)); } }); } /** * @desc Creates a new Account of record type 'Licensed Affiliate' in Salesforce and corresponding permissions and roles. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {Affiliate} affiliate - Affiliate to create * @returns {Promise&lt;any&gt;} * @memberof AffiliatesService */ create(affiliate) { return __awaiter(this, void 0, void 0, function* () { affiliate.RecordTypeId = '012A0000000zpraIAA'; // Use the shingo-sf-api to create the new record const data = { object: 'Account', records: [{ contents: JSON.stringify(affiliate) }] }; const result = (yield this.sfService.create(data))[0]; yield this.map(result.id); return Promise.resolve(result); }); } /** * @desc Create the corresponding permissions and roles for the Affiliate in the Shingo Auth API. * * @param {string} id - Affiliate's Account Id * @returns {Promise&lt;any&gt;} * @memberof AffiliatesService */ map(id) { return __awaiter(this, void 0, void 0, function* () { const cm = yield this.authService.createRole({ name: `Course Manager -- ${id}`, service: 'affiliate-portal' }); for (const level of [0, 1, 2]) { const workshopPerm = yield this.authService.createPermission({ resource: `workshops -- ${id}`, level }); yield this.authService.grantPermissionToRole(workshopPerm.resource, 2, cm.id); const affiliatePerm = yield this.authService.createPermission({ resource: `affiliate -- ${id}`, level }); yield this.authService.grantPermissionToRole(affiliatePerm.resource, 1, cm.id); } return Promise.resolve(); }); } /** * @desc Updates an Affiliate's fields: Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {Affiliate} affiliate - Affiliate's fields to update * @returns {Promise&lt;SFSuccessObject&gt;} * @memberof AffiliatesService */ update(affiliate) { return __awaiter(this, void 0, void 0, function* () { // Use the shingo-sf-api to create the new record const data = { object: 'Account', records: [{ contents: JSON.stringify(affiliate) }] }; const result = (yield this.sfService.update(data))[0]; return Promise.resolve(result); }); } /** * @desc Removes all permissions, roles, and user logins associated with the Affiliate. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {string} id - Salesforce Id of the Account to &quot;delete&quot; * @returns {Promise&lt;any&gt;} * @memberof AffiliatesService */ delete(id) { return __awaiter(this, void 0, void 0, function* () { const result = yield this.get(id); result.RecordTypeId = '012A0000000zprfIAA'; yield this.deletePermissions(result.Id); yield this.deleteRoles(result.Id); yield this.deleteFacilitators(result.Id); const update = yield this.update(result); return Promise.resolve(update); }); } /** * @desc Delete the associated permissions of an Affiliate from the Auth API. Namely 'workshops -- ID' and 'affiliate -- ID' * * @private * @param {SalesforceId} id - The Affilaite's Salesforce Id * @returns {Promise&lt;void&gt;} * @memberof AffiliatesService */ deletePermissions(id) { return __awaiter(this, void 0, void 0, function* () { for (const level of [0, 1, 2]) { yield this.authService.deletePermission(`workshops -- ${id}`, level); yield this.authService.deletePermission(`affiliate -- ${id}`, level); } return Promise.resolve(); }); } /** * @desc Delete the Affiliate specific roles from the Auth API. Namely, 'Course Manager -- ID' * * @private * @param {SalesforceId} id - The Affiliate's Salesforce Id * @returns {Promise&lt;void&gt;} * @memberof AffiliatesService */ deleteRoles(id) { return __awaiter(this, void 0, void 0, function* () { const cm = yield this.authService.getRole(`role.name='Course Manager -- ${id}'`); yield this.authService.deleteRole(cm); return Promise.resolve(); }); } /** * @desc Delete the Affiliate's Facilitators logins from the Auth API. * * @private * @param {SalseforceId} id - The Affiliate's SalesforceId * @returns {Promise&lt;void&gt;} * @memberof AffiliatesService */ deleteFacilitators(id) { return __awaiter(this, void 0, void 0, function* () { const query = { action: &quot;SELECT&quot;, fields: [&quot;Id&quot;], table: &quot;Contact&quot;, clauses: `Facilitator_For__c='${id}' AND RecordType.Name='Affiliate Instructor'` }; const facilitators = (yield this.sfService.query(query)).records; for (const facilitator of facilitators) { yield this.authService.deleteUser({ extId: facilitator.Id }); } return Promise.resolve(); }); } }; AffiliatesService = __decorate([ common_1.Component(), __param(0, common_1.Inject('SalesforceService')), __param(1, common_1.Inject('AuthService')), __param(2, common_1.Inject('CacheService')), __param(3, common_1.Inject('LoggerService')), __metadata(&quot;design:paramtypes&quot;, [_1.SalesforceService, _1.AuthService, _1.CacheService, _1.LoggerService]) ], AffiliatesService); exports.AffiliatesService = AffiliatesService; × Search results Close "},"app.module.js.html":{"id":"app.module.js.html","title":"Source: app.module.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: app.module.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const controllers_1 = require(&quot;./controllers&quot;); const middleware_1 = require(&quot;./middleware&quot;); const components_1 = require(&quot;./components&quot;); const factories_1 = require(&quot;./factories&quot;); /** * The NestJS application module ties together the controllers and components. It also configures any nest middleware. * * @export * @class ApplicationModule */ let ApplicationModule = class ApplicationModule { configure(consumer) { if (process.env.DEBUG_ROUTES === 'true') { consumer.apply(middleware_1.RouteLoggerMiddleware) .forRoutes(controllers_1.WorkshopsController, controllers_1.AuthController, controllers_1.AffiliatesController, controllers_1.FacilitatorsController); } // Protect all routes that must have a user logged in consumer.apply(middleware_1.IsValidMiddleware) .forRoutes(controllers_1.FacilitatorsController, { path: '/workshops', method: common_1.RequestMethod.ALL }, { path: '/workshops/a*', method: common_1.RequestMethod.ALL }, { path: '/workshops/search', method: common_1.RequestMethod.ALL }, { path: '/workshops/describe', method: common_1.RequestMethod.ALL }, { path: '/auth/logout', method: common_1.RequestMethod.ALL }, { path: '/auth/valid', method: common_1.RequestMethod.ALL }, { path: '/affiliates/*', method: common_1.RequestMethod.GET }, { path: '/affiliates*', method: common_1.RequestMethod.POST }, { path: '/affiliates*', method: common_1.RequestMethod.PUT }, { path: '/affiliates*', method: common_1.RequestMethod.DELETE }); // Protect all routes that require a read on the Affiliate consumer.apply(middleware_1.AuthMiddleware) .with(1, 'affiliate -- ') .forRoutes({ path: '/facilitators', method: common_1.RequestMethod.GET }, { path: '/facilitators/*', method: common_1.RequestMethod.GET }, { path: '/affiliates/*', method: common_1.RequestMethod.GET }); // Protect all routes that require the user to be an Affiliate Manager consumer.apply(middleware_1.IsAFManMiddleware) .forRoutes({ path: '/facilitators*', method: common_1.RequestMethod.POST }, { path: '/facilitators*', method: common_1.RequestMethod.PUT }, { path: '/facilitators*', method: common_1.RequestMethod.DELETE }, { path: '/affiliates*', method: common_1.RequestMethod.POST }, { path: '/affiliates*', method: common_1.RequestMethod.PUT }, { path: '/affiliates*', method: common_1.RequestMethod.DELETE }); // Protect all routes that require workshop creation permissions consumer.apply(middleware_1.AuthMiddleware) .with(2, 'workshops -- ') .forRoutes({ path: '/workshops', method: common_1.RequestMethod.POST }); // Protect all routes that require read permissions for a workshop consumer.apply(middleware_1.AuthMiddleware) .with(1) .forRoutes({ path: '/workshops/a*', method: common_1.RequestMethod.GET }); // Protect all routes that require write permissions for a workshop consumer.apply(middleware_1.AuthMiddleware) .with(2) .forRoutes({ path: '/workshops/a*', method: common_1.RequestMethod.PUT }, { path: '/workshops/a*', method: common_1.RequestMethod.DELETE }); } }; ApplicationModule = __decorate([ common_1.Module({ controllers: [controllers_1.WorkshopsController, controllers_1.AuthController, controllers_1.FacilitatorsController, controllers_1.AffiliatesController], components: [ middleware_1.AuthMiddleware, components_1.LoggerService, components_1.CacheService, components_1.UserService, components_1.SalesforceService, components_1.AuthService, components_1.WorkshopsService, components_1.FacilitatorsService, components_1.AffiliatesService, factories_1.MulterFactory ] }) ], ApplicationModule); exports.ApplicationModule = ApplicationModule; × Search results Close "},"controllers_auth_auth.controller.js.html":{"id":"controllers_auth_auth.controller.js.html","title":"Source: controllers/auth/auth.controller.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: controllers/auth/auth.controller.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../../components&quot;); const base_controller_1 = require(&quot;../base.controller&quot;); const _ = require(&quot;lodash&quot;); /** * @desc Provides the controller of the Auth REST logic * * @export * @class AuthController * @extends {BaseController} */ let AuthController = class AuthController extends base_controller_1.BaseController { constructor(sfService, authService, logger) { super(logger); this.sfService = sfService; this.authService = authService; } ; /** * @desc &lt;h5&gt;POST: /auth/login&lt;/h5&gt; Calls {@link AuthService#login} and {@link SalesforceService#query} to login a user * * @param {any} body - Required fields: &lt;code&gt;[ 'email', 'password' ]&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is an object with the user's JWT * @memberof AuthController */ login(req, res, body) { return __awaiter(this, void 0, void 0, function* () { if (!body.email || !body.password) return this.handleError(res, 'Error in AuthController.login(): ', { error: &quot;MISSING_FIELDS&quot; }, common_1.HttpStatus.BAD_REQUEST); try { const user = yield this.authService.login(body); if (user === undefined) return this.handleError(res, 'Error in AuthController.login(): ', { error: 'INVALID_LOGIN' }, common_1.HttpStatus.FORBIDDEN); if (!user.services.includes('affiliate-portal')) return this.handleError(res, 'Error in AuthController.login(): ', { error: 'NOT_REGISTERED' }, common_1.HttpStatus.NOT_FOUND); const query = { action: 'SELECT', fields: [ 'Id', 'Name', 'FirstName', 'LastName', 'AccountId', 'Email' ], table: 'Contact', clauses: `Email='${body.email}' AND RecordType.Name='Affiliate Instructor'` }; const contact = (yield this.sfService.query(query)).records[0]; req.session.user = _.omit(user, ['password', 'roles']); req.session.user = _.merge(contact, _.omit(req.session.user, ['email'])); req.session.user.role = user.roles.map(role =&gt; { if (role.service === 'affiliate-portal') return _.omit(role, ['users', 'service']); })[0]; req.session.affiliate = contact['AccountId']; return res.status(common_1.HttpStatus.OK).json(_.omit(req.session.user, ['permissions', 'extId', 'services', 'role.permissions'])); } catch (error) { return this.handleError(res, 'Error in AuthController.login(): ', error); } }); } /** * &lt;h5&gt;GET: /auth/valid&lt;/h5&gt; Protected by isValid middleware. Returns the user's JWT * * @returns {Promise&lt;Response&gt;} * @memberof AuthController */ valid(req, res) { return __awaiter(this, void 0, void 0, function* () { return res.status(common_1.HttpStatus.OK).json(_.omit(req.session.user, ['permissions', 'extId', 'services', 'role.permissions'])); }); } /** * @desc &lt;h5&gt;GET: /auth/logout&lt;/h5&gt; Calls {@link AuthService#updateUser} to set the user's JWT to '' and removes the user from the session * * @returns {Promise&lt;Response&gt;} * @memberof AuthController */ logout(req, res) { return __awaiter(this, void 0, void 0, function* () { if (!req.session.user) return this.handleError(res, 'Error in AuthController.logout(): ', { error: 'NO_LOGIN_FOUND' }, common_1.HttpStatus.NOT_FOUND); try { req.session.user.jwt = ''; let user = yield this.authService.updateUser(_.omit(req.session.user, ['Id', 'FirstName', 'LastName', 'Email', 'AccountId', 'Name', 'password', 'role'])); req.session.user = null; return res.status(common_1.HttpStatus.OK).json({ message: &quot;LOGOUT_SUCCESS&quot; }); } catch (error) { return this.handleError(res, 'Error in AuthController.logout(): ', error); } }); } }; __decorate([ common_1.Post('login'), __param(0, common_1.Request()), __param(1, common_1.Response()), __param(2, common_1.Body()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AuthController.prototype, &quot;login&quot;, null); __decorate([ common_1.Get('valid'), __param(0, common_1.Request()), __param(1, common_1.Response()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AuthController.prototype, &quot;valid&quot;, null); __decorate([ common_1.Get('logout'), __param(0, common_1.Request()), __param(1, common_1.Response()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], AuthController.prototype, &quot;logout&quot;, null); AuthController = __decorate([ common_1.Controller('auth'), __metadata(&quot;design:paramtypes&quot;, [components_1.SalesforceService, components_1.AuthService, components_1.LoggerService]) ], AuthController); exports.AuthController = AuthController; × Search results Close "},"middleware_auth.middleware.js.html":{"id":"middleware_auth.middleware.js.html","title":"Source: middleware/auth.middleware.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: middleware/auth.middleware.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../components&quot;); /** * The auth middleware uses the Shingo Auth API to test if the user has permissions to access a given resource * * @export * @class AuthMiddleware * @implements {NestMiddleware} */ let AuthMiddleware = class AuthMiddleware { constructor() { this.authService = new components_1.AuthService(); this.log = new components_1.LoggerService(); } /** * The function called when the middleware is activated. Calls {@link AuthService#canAccess}. NOTE: If user is an Affiliate Manager all check logic is skipped as the user implicitly has all permissions. * * @param {(1|2)} level - The level of permissions required (1=Read,2=Write) * @param {string} [resource] - The resource being accessed * @returns {void} * @memberof AuthMiddleware */ resolve(level, resource) { return (req, res, next) =&gt; { let isAfMan = req.session.user &amp;&amp; req.session.user.role.name === 'Affiliate Manager'; if (isAfMan) return next(); if (resource &amp;&amp; resource.match(/^.*\\s--\\s$/)) resource += req.session.affiliate; else if (!resource) resource = `${req.path}`; if (resource.match(/^\\/workshops\\/.*\\/facilitators/)) resource = resource.split('/facilitators')[0]; return this.authService.canAccess(resource, 2, req.header['x-jwt']) .then(result =&gt; { if (resource.includes('affiliate -- ')) resource = 'affiliate -- '; else resource = ''; if (result &amp;&amp; result.response) return next(); throw { error: 'ACCESS_FORBIDDEN' }; }) .catch(error =&gt; { if (error.metadata) error = components_1.SalesforceService.parseRPCErrorMeta(error); this.log.error('Error in AuthMiddleware.resolve(): %j', error); return res.status(common_1.HttpStatus.FORBIDDEN).json(error); }); }; } }; AuthMiddleware = __decorate([ common_1.Middleware(), __metadata(&quot;design:paramtypes&quot;, []) ], AuthMiddleware); exports.AuthMiddleware = AuthMiddleware; × Search results Close "},"components_auth_auth.component.js.html":{"id":"components_auth_auth.component.js.html","title":"Source: components/auth/auth.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/auth/auth.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const grpc = require(&quot;grpc&quot;); const path = require(&quot;path&quot;); const bluebird = require(&quot;bluebird&quot;); const authservices = grpc.load(path.join(__dirname, '../../../proto/auth_services.proto')).authservices; /** * @desc A service to abastract the Shingo Auth Microservice client * * @export * @class AuthService */ let AuthService = class AuthService { constructor() { this.client = bluebird.promisifyAll(this.getClient()); } /** * @desc Method to instantiate a RPC Client from the auth_services.proto * * @private * @returns Returns a RPC Client to be used in consuming the Shingo Auth Microservice * @memberof AuthService */ getClient() { return new authservices.AuthServices(`${process.env.AUTH_API}:80`, grpc.credentials.createInsecure()); } /** * Get an array of users based upon a TypeORM query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getUsers(clause) { return this.client.readUserAsync({ clause }); } /** * Get a single user based upon a TypeORM query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getUser(clause) { return this.client.readOneUserAsync({ clause }); } /** * Create a user in the Auth Database * * @param {User} user - Expecting &lt;code&gt;{&quot;email&quot;, &quot;password&quot;, &quot;services&quot;, &quot;extId?&quot;}&lt;/code&gt; * @returns {Promise&lt;any&gt;} * @memberof AuthService */ createUser(user) { return this.client.createUserAsync(user); } /** * Update a user in the Auth Database * * @param {User} user - Expecting &lt;code&gt;{oneormoreof: {&quot;email&quot;, &quot;password&quot;, &quot;services&quot;}, oneof: {&quot;id&quot;, extId&quot;}}&lt;/code&gt; * @returns {Promise&lt;any&gt;} * @memberof AuthService */ updateUser(user) { return this.client.updateUserAsync(user); } /** * Delete a user from the Auth Database * * @param {User} user - User to delete * @returns {Promise&lt;any&gt;} * @memberof AuthService */ deleteUser(user) { return this.client.deleteUserAsync(user); } /** * Add a role to a user by email * * @param {RoleRequest} set - User and Role to associate * @returns {Promise&lt;any&gt;} * @memberof AuthService */ addRoleToUser(set) { return this.client.addRoleToUserAsync(set); } /** * Remove a role from a user by email * * @param {RoleRequest} set - User and Role to disassociate * @returns {Promise&lt;any&gt;} * @memberof AuthService */ removeRoleFromUser(set) { return this.client.removeRoleFromUserAsync(set); } /** * Get an array of permissions based on TypeORM query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getPermissions(clause) { return this.client.readPermissionAsync({ clause }); } /** * Get a single permission based on a TypeORM Query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getPermission(clause) { return this.client.readOnePermissionAsync({ clause }); } /** * Create a permission. * * @param {Permission} permission - Permission to be created * @returns {Promise&lt;any&gt;} * @memberof AuthService */ createPermission(permission) { return this.client.createPermissionAsync(permission); } /** * Update a permission * * @param {Permission} permission - Permission to update * @returns {Promise&lt;any&gt;} * @memberof AuthService */ updatePermission(permission) { return this.client.updatePermissionAsync(permission); } /** * Delete a permission * * @param {string} resource - Permission resource * @param {(0 | 1 | 2)} level - Permission level * @returns {Promise&lt;any&gt;} * @memberof AuthService */ deletePermission(resource, level) { return this.client.deletePermissionAsync({ resource, level }); } /** * Get an array of roles based on a TypeORM query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getRoles(clause) { return this.client.readRoleAsync({ clause }); } /** * Get a single role based on a TypeORM query * * @param {string} clause - A TypeORM query. See [here](https://typeorm.github.io/query-builder.html) for some examples * @returns {Promise&lt;any&gt;} * @memberof AuthService */ getRole(clause) { return this.client.readOneRoleAsync({ clause }); } /** * Create a role * * @param {Role} role - Role to create * @returns {Promise&lt;any&gt;} * @memberof AuthService */ createRole(role) { return this.client.createRoleAsync(role); } /** * Update a role * * @param {Role} role - Role to update * @returns {Promise&lt;any&gt;} * @memberof AuthService */ updateRole(role) { return this.client.updateRoleAsync(role); } /** * Delete a role * * @param {Role} role - Id of role to delete * @returns {Promise&lt;any&gt;} * @memberof AuthService */ deleteRole(role) { return this.client.deleteRoleAsync(role); } /** * Grant permission to a user based on resource and level * * @param {string} resource - Resource to grant permissions to * @param {(0 | 1 | 2)} level - Level to grant (0=Deny,1=Read,2=Write) * @param {number} userId - User's Id * @returns {Promise&lt;any&gt;} * @memberof AuthService */ grantPermissionToUser(resource, level, userId) { return this.client.grantPermissionToUserAsync({ resource, level, accessorId: userId }); } /** * Grant permission to a role based on resource and level * * @param {string} resource - Resource to grant permissions to * @param {(0 | 1 | 2)} level - Level to grant (0=Deny,1=Read,2=Write) * @param {number} roleId - Role's Id * @returns {Promise&lt;any&gt;} * @memberof AuthService */ grantPermissionToRole(resource, level, roleId) { return this.client.grantPermissionToRoleAsync({ resource, level, accessorId: roleId }); } /** * Revoke permission from a user based on resource and level * * @param {string} resource - Resource to grant permissions to * @param {(0 | 1 | 2)} level - Level to grant (0=Deny,1=Read,2=Write) * @param {number} userId - User's Id * @returns {Promise&lt;any&gt;} * @memberof AuthService */ revokePermissionFromUser(resource, level, userId) { return this.client.revokePermissionFromUserAsync({ resource, level, accessorId: userId }); } /** * Revoke permission from a role based on resource and level * * @param {string} resource - Resource to grant permissions to * @param {(0 | 1 | 2)} level - Level to grant (0=Deny,1=Read,2=Write) * @param {number} roleId - Role's Id * @returns {Promise&lt;any&gt;} * @memberof AuthService */ revokePermissionFromRole(resource, level, roleId) { return this.client.revokePermissionFromRoleAsync({ resource, level, accessorId: roleId }); } /** * Use email and password to login a user * * @param {Credentials} creds * @returns {Promise&lt;any&gt;} * @memberof AuthService */ login(creds) { return this.client.loginAsync(creds); } /** * Check if JWT is valid * * @param {string} token - JWT * @returns {Promise&lt;any&gt;} * @memberof AuthService */ isValid(token) { return this.client.isValidAsync({ token }); } /** * Check if user with JWT can access the requested resource with given permission level * * @param {string} resource - Resource to grant permissions to * @param {(1 | 2)} level - Level of access (1=Read,2=Write) * @param {string} jwt - User's JWT * @returns {Promise&lt;any&gt;} * @memberof AuthService */ canAccess(resource, level, jwt) { return this.client.canAccessAsync({ resource, level, jwt }); } }; AuthService = __decorate([ common_1.Component(), __metadata(&quot;design:paramtypes&quot;, []) ], AuthService); exports.AuthService = AuthService; × Search results Close "},"components_cache_cache.component.js.html":{"id":"components_cache_cache.component.js.html","title":"Source: components/cache/cache.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/cache/cache.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const _1 = require(&quot;../&quot;); const NodeCache = require(&quot;node-cache&quot;); const hash = require(&quot;object-hash&quot;); /** * @desc A service that provides an in-memory cache * * @export * @class CacheService */ let CacheService = class CacheService { constructor(log = new _1.LoggerService()) { this.log = log; this.theCache = new NodeCache({ stdTTL: 1800, checkperiod: 900 }); } /** * @desc Helper function to hash an object to a key * * @private * @param {object} obj * @returns {string} * @memberof CacheService */ getKey(obj) { return hash(obj); } /** * @desc Get the cached result for the give key * * @param {(object | string)} obj * @returns The cached result. 'undefined' if key is not found. * @memberof CacheService */ getCache(obj) { let key = obj; if (typeof obj !== 'string') key = this.getKey(obj); return this.theCache.get(key); } /** * @desc Checks if cache contains key * * @param {(object | string)} obj * @returns {boolean} * @memberof CacheService */ isCached(obj) { let key = obj; if (typeof obj !== 'string') key = this.getKey(obj); return this.theCache.get(key) !== undefined; } /** * @desc Caches the value based on the resulting key. Logs error if not successfully. * * @param {(object | string)} obj * @param {*} value * @memberof CacheService */ cache(obj, value) { let key = obj; if (typeof obj !== 'string') key = this.getKey(obj); if (!value) return; const success = this.theCache.set(key, value); if (!success) this.log.error(&quot;Response could not be cached!&quot;); } }; CacheService = __decorate([ common_1.Component(), __param(0, common_1.Inject('LoggerService')), __metadata(&quot;design:paramtypes&quot;, [_1.LoggerService]) ], CacheService); exports.CacheService = CacheService; × Search results Close "},"controllers_facilitators_facilitators.controller.js.html":{"id":"controllers_facilitators_facilitators.controller.js.html","title":"Source: controllers/facilitators/facilitators.controller.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: controllers/facilitators/facilitators.controller.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../../components&quot;); const base_controller_1 = require(&quot;../base.controller&quot;); const objKeyValidator_1 = require(&quot;../../validators/objKeyValidator&quot;); /** * @desc Controller of the REST API logic for Facilitators * * @export * @class FacilitatorsController * @extends {BaseController} */ let FacilitatorsController = class FacilitatorsController extends base_controller_1.BaseController { constructor(facilitatorsService, logger) { super(logger); this.facilitatorsService = facilitatorsService; } ; /** * @desc &lt;h5&gt;GET: /facilitators&lt;/h5&gt; Call {@link FacilitatorsService#getAll} to get a list of facilitators for given &lt;code&gt;'x-affiliate' || session.affilaite&lt;/code&gt; * * @param {Header} [xAffiliate=''] - Header 'x-affiliate' Used by the 'Affiliate Manager' role to specify the affiliate to query facilitators for ('' queries all affiliates). * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body is JSON Array of objects of type &lt;code&gt;{&lt;em&gt;queried fields&lt;/em&gt;}&lt;/code&gt; * @memberof FacilitatorsController */ readAll(res, session, xAffiliate = '', refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { let isAfMan = session.user &amp;&amp; session.user.role.name === 'Affiliate Manager'; if (!isAfMan &amp;&amp; !session.affiliate) return this.handleError(res, 'Error in FacilitatorsController.readAll(): ', { error: 'MISSING_FIELDS' }, common_1.HttpStatus.FORBIDDEN); try { const facilitators = yield this.facilitatorsService.getAll(refresh === 'true', (isAfMan ? xAffiliate : session.affiliate)); return res.status(common_1.HttpStatus.OK).json(facilitators); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.readAll(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /facilitators/describe&lt;/h5&gt; Calls {@link FacilitatorsService#describe} to describe Contact * * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body is a JSON object with the describe result * @memberof FacilitatorsController */ describe(res, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { try { const describeObject = yield this.facilitatorsService.describe(refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(describeObject); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.describe(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /facilitators/search&lt;/h5&gt; Calls {@link FacilitatorsService#search} to search for facilitators * * * @param {Header} search - Header 'x-search'. SOSL search expression (i.e. '*Test*') * @param {Header} retrieve - Header 'x-retrieve'. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name, Email') * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body is a JSON Array of objects of type {&lt;em&gt;retrieve fields&lt;/em&gt;} * @memberof FacilitatorsController */ search(res, session, search, retrieve, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { let isAfMan = session.user.role.name === 'Affiliate Manager'; if (!isAfMan &amp;&amp; !session.affiliate) return this.handleError(res, 'Error in FacilitatorsController.search(): ', { error: 'SESSION_EXPIRED' }, common_1.HttpStatus.FORBIDDEN); // Check for required fields if (!search || !retrieve) return this.handleError(res, 'Error in FacilitatorsController.search(): ', { error: 'MISSING_FIELDS' }, common_1.HttpStatus.BAD_REQUEST); try { const searchRecords = yield this.facilitatorsService.search(search, retrieve, (isAfMan ? '' : session.affiliate), refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(searchRecords); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.search(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /facilitators/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link FacilitatorsService#get} to retrieve a Facilitator * * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is a JSON object of type {&lt;em&gt;returned fields&lt;/em&gt;} * @memberof FacilitatorsController */ read(res, id) { return __awaiter(this, void 0, void 0, function* () { // Check the id if (!id.match(/[\\w\\d]{15,18}/)) return this.handleError(res, 'Error in FacilitatorsController.read(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const facilitator = yield this.facilitatorsService.get(id); return res.status(common_1.HttpStatus.OK).json(facilitator); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.read(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /facilitators&lt;/h5&gt; Calls {@link FacilitatorsService#create} to create a new Facilitator * * @param {Body} body - Required fields: &lt;code&gt;[ 'AccountId', 'FirstName', 'LastName', 'Email', 'password' ]&lt;/code&gt;&lt;br&gt;Optional fields: &lt;code&gt;[ 'roleId' ]&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is a JSON object. * @memberof FacilitatorsController */ create(res, body) { return __awaiter(this, void 0, void 0, function* () { const required = objKeyValidator_1.checkRequired(body, ['AccountId', 'FirstName', 'LastName', 'Email', 'password']); if (!required.valid) return this.handleError(res, 'Error in FacilitatorsController.create(): ', { error: &quot;MISSING_FIELDS&quot;, fields: required.missing }, common_1.HttpStatus.BAD_REQUEST); if (!body.AccountId.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.create(): ', { error: 'INVALID_SF_ID', message: `${body.AccountId} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.facilitatorsService.create(body); return res.status(common_1.HttpStatus.CREATED).json(result); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.create(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /facilitators/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link FacilitatorsService#mapContact} to map an existing Affiliate Instructor Contact to a new/current Auth login * * @param {Body} body - Required fields: &lt;code&gt;[ 'AccountId', 'Email', 'password' ]&lt;/code&gt;&lt;br&gt;Optional fields: &lt;code&gt;['roleId']&lt;/code&gt; * @param {SalesforceId} id - SalesforceId of the Contact to map * @returns {Promise&lt;Response&gt;} * @memberof FacilitatorsController */ map(res, body, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,18}/)) return this.handleError(res, 'Error in FacilitatorsController.map(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); const required = objKeyValidator_1.checkRequired(body, ['AccountId', 'Email', 'password']); if (!required.valid) return this.handleError(res, 'Error in FacilitatorsController.map(): ', { error: &quot;MISSING_FIELDS&quot;, fields: required.missing }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.facilitatorsService.mapContact(id, body); return res.status(common_1.HttpStatus.CREATED).json(result); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.map(): ', error); } }); } /** * @desc &lt;h5&gt;PUT: /facilitators/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link FacilitatorsService#update} to update a Facilitator. If &lt;code&gt;body&lt;/code&gt; contains &lt;code&gt;Email&lt;/code&gt; or &lt;code&gt;password&lt;/code&gt; the associated auth is also updated. * * @param {any} body - Required fields &lt;code&gt;{ ['Id'], oneof: ['FirstName', 'LastName', 'Email', 'password', 'Biography', etc..] }&lt;/code&gt; * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is status of updates and resulting SF Operation * @memberof FacilitatorsController */ update(res, body, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.update(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); if (!body.Id || body.Id !== id) return this.handleError(res, 'Error in FacilitatorsController.update(): ', { error: &quot;MISSING_FIELDS&quot;, fields: [&quot;Id&quot;] }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.facilitatorsService.update(body); return res.status(common_1.HttpStatus.OK).json(result); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.update(): ', error); } }); } /** * @desc &lt;h5&gt;DELETE: /facilitators/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link FacilitatorsService#delete}, {@link FacilitatorsService#deleteAuth} or {@link FacilitatorsService#unmapAuth} to remove a facilitator from the affiliate portal * * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @param {string} [deleteAuth='true'] - Delete auth as well * @returns {Promise&lt;Response&gt;} Response is status of deletes and resulting SF Operation * @memberof FacilitatorsController */ delete(res, id, deleteAuth = 'true') { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.delete(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const record = yield this.facilitatorsService.delete(id); let deleted = false; if (deleteAuth === 'true') deleted = yield this.facilitatorsService.deleteAuth(id); else yield this.facilitatorsService.unmapAuth(id); return res.status(common_1.HttpStatus.OK).json({ salesforce: true, auth: deleted, record }); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.delete(): ', error); } }); } /** * @desc &lt;h5&gt;DELETE: /facilitators/&lt;em&gt;:id&lt;/em&gt;/login&lt;/h5&gt; Calls {@link FacilitatorsService#deleteAuth} to delete a Facilitator's login only * * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is result of delete * @memberof FacilitatorsController */ deleteLogin(res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.deleteLogin(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const deleted = yield this.facilitatorsService.deleteAuth(id); return res.status(common_1.HttpStatus.OK).json({ deleted }); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.deleteLogin(): ', error); } }); } /** * @desc &lt;h5&gt;DELETE: /facilitators/&lt;em&gt;:id&lt;/em&gt;/unmap&lt;/h5&gt; Calls {@link FacilitatorsService#unmapAuth} to remove the Affiliate Portal service from a login * * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Reponse body is result of unmap * @memberof FacilitatorsController */ unamp(res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.unmap(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const unmaped = yield this.facilitatorsService.unmapAuth(id); return res.status(common_1.HttpStatus.OK).json({ unmaped }); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.unmap(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /facilitators/&lt;em&gt;:id&lt;/em&gt;/roles/&lt;em&gt;:roleId&lt;/em&gt;&lt;/h5&gt; Calls {@link FacilitatorsService#changeRole} to change a Facilitator's role * * @param {SalesforceId} id - Contact id. match &lt;code&gt;/[\\w\\d]{15,17}/&lt;/code&gt; * @param {number} roleId - Id of the role to change too * @returns {Promise&lt;Response&gt;} Response body is result of add * @memberof FacilitatorsController */ changeRole(res, id, roleId) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in FacilitatorsController.changeRole(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const added = this.facilitatorsService.changeRole(id, roleId); return res.status(common_1.HttpStatus.OK).json({ added }); } catch (error) { return this.handleError(res, 'Error in FacilitatorsController.changeRole(): ', error); } }); } }; __decorate([ common_1.Get(''), __param(0, common_1.Response()), __param(1, common_1.Session()), __param(2, common_1.Headers('x-affiliate')), __param(3, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;readAll&quot;, null); __decorate([ common_1.Get('/describe'), __param(0, common_1.Response()), __param(1, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;describe&quot;, null); __decorate([ common_1.Get('/search'), __param(0, common_1.Response()), __param(1, common_1.Session()), __param(2, common_1.Headers('x-search')), __param(3, common_1.Headers('x-retrieve')), __param(4, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;search&quot;, null); __decorate([ common_1.Get('/:id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;read&quot;, null); __decorate([ common_1.Post(), __param(0, common_1.Response()), __param(1, common_1.Body()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;create&quot;, null); __decorate([ common_1.Post('/:id'), __param(0, common_1.Response()), __param(1, common_1.Body()), __param(2, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;map&quot;, null); __decorate([ common_1.Put('/:id'), __param(0, common_1.Response()), __param(1, common_1.Body()), __param(2, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;update&quot;, null); __decorate([ common_1.Delete('/:id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __param(2, common_1.Query('deleteAuth')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;delete&quot;, null); __decorate([ common_1.Delete('/:id/login'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;deleteLogin&quot;, null); __decorate([ common_1.Delete('/:id/unmap'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;unamp&quot;, null); __decorate([ common_1.Post('/:id/roles/:roleId'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __param(2, common_1.Param('roleId')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], FacilitatorsController.prototype, &quot;changeRole&quot;, null); FacilitatorsController = __decorate([ common_1.Controller('facilitators'), __metadata(&quot;design:paramtypes&quot;, [components_1.FacilitatorsService, components_1.LoggerService]) ], FacilitatorsController); exports.FacilitatorsController = FacilitatorsController; × Search results Close "},"components_facilitators_facilitators.component.js.html":{"id":"components_facilitators_facilitators.component.js.html","title":"Source: components/facilitators/facilitators.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/facilitators/facilitators.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const _1 = require(&quot;../&quot;); const _ = require(&quot;lodash&quot;); /** * @desc A service to provide functions for working with Facilitators * * @export * @class FacilitatorsService */ let FacilitatorsService = class FacilitatorsService { constructor(sfService = new _1.SalesforceService(), authService = new _1.AuthService(), cache = new _1.CacheService(), log = new _1.LoggerService()) { this.sfService = sfService; this.authService = authService; this.cache = cache; this.log = log; } /** * @desc Get all facilitators for the affiliate specified. All if &lt;code&gt;affiliate === ''&lt;/code&gt;. The queried fields from Salesforce are as follows:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;&quot;Id&quot;,&lt;br&gt; * &amp;emsp;&quot;FirstName&quot;,&lt;br&gt; * &amp;emsp;&quot;LastName&quot;,&lt;br&gt; * &amp;emsp;&quot;Email&quot;,&lt;br&gt; * &amp;emsp;&quot;Title&quot;,&lt;br&gt; * &amp;emsp;&quot;Account.Id&quot;,&lt;br&gt; * &amp;emsp;&quot;Account.Name&quot;,&lt;br&gt; * &amp;emsp;&quot;Facilitator_For\\__r.Id&quot;,&lt;br&gt; * &amp;emsp;&quot;Facilitator_For\\__r.Name&quot;,&lt;br&gt; * &amp;emsp;&quot;Photograph\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Biography\\__c&quot;&lt;br&gt; * ]&lt;/code&gt; * * @param {boolean} [refresh=false] - Force the refresh of the cache * @param {string} [affiliate] - SF Id of the affiliate to get facilitators for (or '' to get all facilitators) * @returns {Promise&lt;any[]&gt;} * @memberof FacilitatorsService */ getAll(refresh = false, affiliate) { return __awaiter(this, void 0, void 0, function* () { let query = { action: &quot;SELECT&quot;, fields: [ &quot;Id&quot;, &quot;FirstName&quot;, &quot;LastName&quot;, &quot;Email&quot;, &quot;Title&quot;, &quot;Account.Id&quot;, &quot;Account.Name&quot;, &quot;Facilitator_For__r.Id&quot;, &quot;Facilitator_For__r.Name&quot;, &quot;Photograph__c&quot;, &quot;Biography__c&quot; ], table: &quot;Contact&quot;, clauses: `RecordType.Name='Affiliate Instructor'` }; if (affiliate != '') query.clauses += ` AND Facilitator_For__c='${affiliate}'`; if (!this.cache.isCached(query) || refresh) { let facilitators = (yield this.sfService.query(query)).records; const ids = facilitators.map(facilitator =&gt; { return `'${facilitator['Id']}'`; }); const usersArr = (yield this.authService.getUsers(`user.extId IN (${ids.join()})`)).users; const users = _.keyBy(usersArr, 'extId'); // Add the facilitator's auth id to object for (let facilitator of facilitators) { if (users[facilitator['Id']]) facilitator['id'] = users[facilitator['Id']].id; } facilitators = facilitators.filter(facilitator =&gt; { return facilitator['id'] !== undefined; }); this.cache.cache(query, facilitators); return Promise.resolve(facilitators); } else { return Promise.resolve(this.cache.getCache(query)); } }); } /** * @desc Uses the Salesforce REST API to describe the Contact object. See the Salesforce documentation for more about 'describe' * * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ describe(refresh = false) { return __awaiter(this, void 0, void 0, function* () { const key = 'describeContact'; if (!this.cache.isCached(key) || refresh) { const describeObject = yield this.sfService.describe('Contact'); this.cache.cache(key, describeObject); return Promise.resolve(describeObject); } else { return Promise.resolve(this.cache.getCache(key)); } }); } /** * @desc Executes a SOSL query to search for text on Contacts of record type Affiliate Instructor Salesforce. Example response body:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZAAZ&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test One&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Email&quot;: &quot;testone@example.com&quot;&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZABA&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Two&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Email&quot;: &quot;testtwo@example.com&quot;&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;003g000001VvwEZABB&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Three&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Email&quot;: &quot;testthree@example.com&quot;&lt;br&gt; * &amp;emsp;},&lt;br&gt; * ]&lt;/code&gt; * * @param {Header} search - Header 'x-search'. SOSL search expression (i.e. '*Test*'). * @param {Header} retrieve - Header 'x-retrieve'. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name, Email') * @param {string} [affiliate=''] - The SF Id to filter results for (or '' for no filter) * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ search(search, retrieve, affiliate = '', refresh = false) { return __awaiter(this, void 0, void 0, function* () { // Generate the data parameter for the RPC call if (!retrieve.includes('AccountId')) retrieve += ', AccountId'; if (!retrieve.includes('RecordType.Name')) retrieve += ', RecordType.Name'; if (!retrieve.includes('Id')) retrieve += ', Id'; const data = { search: `{${search}}`, retrieve: `Contact(${retrieve})` }; if (!this.cache.isCached(data) || refresh) { let facilitators = (yield this.sfService.search(data)).searchRecords || []; facilitators = facilitators.filter(result =&gt; { if (affiliate === '') return result.RecordType.Name === 'Affiliate Instructor'; else return result.AccountId === affiliate &amp;&amp; result.RecordType.Name === 'Affiliate Instructor'; }); if (facilitators.length) { const ids = facilitators.map(facilitator =&gt; { return `'${facilitator['Id']}'`; }); const usersArr = (yield this.authService.getUsers(`user.extId IN (${ids.join()})`)).users; const users = _.keyBy(usersArr, 'extId'); // Add the facilitator's auth id to the object for (let facilitator of facilitators) { if (users[facilitator['Id']]) facilitator['id'] = users[facilitator['Id']].id; } facilitators = facilitators.filter(facilitator =&gt; { return facilitator['id'] !== undefined; }); } this.cache.cache(data, facilitators); return Promise.resolve(facilitators); } else { return Promise.resolve(this.cache.getCache(data)); } }); } /** * @desc Get the facilitator with the id passed at the parameter :id. The following fields are returned:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * TODO: Add fields that are returned&lt;br&gt; * ]&lt;/code&gt; * * @param {string} id - Salesforce ID for a Contact * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ get(id) { return __awaiter(this, void 0, void 0, function* () { // Create the data parameter for the RPC call const data = { object: 'Contact', ids: [id] }; const facilitator = (yield this.sfService.retrieve(data))[0]; const user = yield this.authService.getUser(`user.email='${facilitator.Email}'`); return Promise.resolve(_.merge(facilitator, _.omit(user, ['email', 'password']))); }); } /** * @desc Creates a new Contact of record type 'Affiliate Instructor' in Salesforce and addes a user to the Shingo Auth api. The user create for the Auth API will be assigned the role of roleId (defaults to 'Facilitator'). Returns a response like:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;jwt&quot;: string,&lt;br&gt; * &amp;emsp;&quot;id:&quot; number&lt;br&gt; * }&lt;/code&gt; * * @param {any} user - User to create * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ create(user) { return __awaiter(this, void 0, void 0, function* () { let contact = _.omit(user, [&quot;password&quot;, &quot;roleId&quot;]); // Create the contact in Salesforce contact.RecordTypeId = '012A0000000zpqrIAA'; const data = { object: 'Contact', records: [{ contents: JSON.stringify(contact) }] }; const record = (yield this.sfService.create(data))[0]; return this.createOrMapAuth(record.id, user); }); } /** * @desc Maps an existing Contact record to a new/current login * * @param {SalesforceId} id - The Salesforce Id of the Contact to map * @param {any} user * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ mapContact(id, user) { return __awaiter(this, void 0, void 0, function* () { const data = { object: 'Contact', ids: [id] }; const record = (yield this.sfService.retrieve(data))[0]; if (record === undefined) return Promise.reject({ error: 'CONTACT_NOT_FOUND' }); if (record.RecordTypeId !== '012A0000000zpqrIAA') { record.RecordTypeId = '012A0000000zpqrIAA'; const updateData = { object: 'Contact', records: [{ contents: JSON.stringify(record) }] }; const successObject = (yield this.sfService.update(updateData))[0]; } return this.createOrMapAuth(id, user); }); } /** * @desc Searches for an existing user with the same email. If not found, one is created, else the 'affiliate-portal' service is added and permissions are granted. * * @param {SalesforceId} id - Salesforce Id of the associated contact * @param {any} user * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ createOrMapAuth(id, user) { return __awaiter(this, void 0, void 0, function* () { const roleId = (user.roleId ? user.roleId : global['facilitatorId']); let auth = yield this.authService.getUser(`user.email='${user.Email}'`); if (auth.email === '') { auth = yield this.createNewAuth(user.Email, user.password, roleId, id); } else { auth = yield this.mapCurrentAuth(user.Email, roleId, id); } yield this.authService.grantPermissionToUser(`affiliate -- ${user.AccountId}`, 1, auth.id); yield this.authService.grantPermissionToUser(`workshops -- ${user.AccountId}`, 2, auth.id); return Promise.resolve(Object.assign({ id: id }, auth)); }); } /** * @desc Uses the Shingo Auth API to create a new login * * @param {string} email * @param {string} password * @param {number} roleId * @param {string} extId - Salesforce Id of the associated contact * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ createNewAuth(email, password, roleId, extId) { return __awaiter(this, void 0, void 0, function* () { const user = yield this.authService.createUser({ email, password, services: 'affiliate-portal', extId }); yield this.authService.addRoleToUser({ userEmail: email, roleId }); return Promise.resolve({ jwt: user.jwt, id: user.id }); }); } /** * @desc Uses the Shingo Auth API to map a Salesforce contact to a current login * * @param {string} userEmail * @param {number} roleId * @param {string} extId - Salesforce Id of the associated contact * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ mapCurrentAuth(userEmail, roleId, extId) { return __awaiter(this, void 0, void 0, function* () { const user = yield this.authService.getUser(`user.email='${userEmail}'`); if (user === undefined) return Promise.reject({ error: 'USER_NOT_FOUND' }); user.extId = extId; user.services = (user.services === '' ? 'affiliate-portal' : user.services + ', affiliate-portal'); yield this.authService.updateUser(user); yield this.authService.addRoleToUser({ userEmail, roleId }); return Promise.resolve({ jwt: user.jwt, id: user.id }); }); } /** * @desc Updates a facilitator's fields. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;record&quot;: {&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;errors&quot;: []&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;&quot;salesforce&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;auth&quot;: boolean * }&lt;/code&gt; * * @param {any} user - The facilitator's fields to update * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ update(user) { return __awaiter(this, void 0, void 0, function* () { const contact = _.omit(user, [&quot;password&quot;]); const data = { object: 'Contact', records: [{ contents: JSON.stringify(contact) }] }; const record = (yield this.sfService.update(data))[0]; if (user.Email || user.password) { return Promise.resolve({ salesforce: true, auth: yield this.updateAuth(user, record.id), record }); } return Promise.resolve({ salesforce: true, auth: false, record }); }); } /** * @desc Update the associated login of a facilitator * * @param {any} user - Facilitator's fields to update * @param {any} extId - Facilitator's Contact ID * @returns {Promise&lt;boolean&gt;} * @memberof FacilitatorsService */ updateAuth(user, extId) { return __awaiter(this, void 0, void 0, function* () { const set = { extId }; if (user.Email) set['email'] = user.Email; if (user.password) set['password'] = user.password; const updated = yield this.authService.updateUser(set); return Promise.resolve((updated &amp;&amp; updated.response)); }); } /** * @desc Deletes a facilitator. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * * @param {string} id - Salesforce Id of the Contact to delete * @returns {Promise&lt;any&gt;} * @memberof FacilitatorsService */ delete(id) { return __awaiter(this, void 0, void 0, function* () { // Create the data parameter for the RPC call const data = { object: 'Contact', ids: [id] }; const record = (yield this.sfService.delete(data))[0]; return Promise.resolve(record); }); } /** * @desc Delete a login from the Shingo Auth API * * @param {string} extId - Facilitator's Contact Id * @returns {Promise&lt;boolean&gt;} * @memberof FacilitatorsService */ deleteAuth(extId) { return __awaiter(this, void 0, void 0, function* () { const deleted = yield this.authService.deleteUser({ extId }); return Promise.resolve(deleted &amp;&amp; deleted.response); }); } /** * @desc Remove the Affiliate Portal as service for a login * * @param {string} extId - Facilitator's Contact Id * @returns {Promise&lt;boolean&gt;} * @memberof FacilitatorsService */ unmapAuth(extId) { return __awaiter(this, void 0, void 0, function* () { const user = yield this.authService.getUser(`user.extId='${extId}'`); if (user === undefined) return Promise.reject({ error: 'USER_NOT_FOUND' }); if (user.services === 'affiliate-portal') user.services = ''; else if (user.services.includes(', affiliate-portal')) user.services = user.services.replace(', affiliate-portal', ''); else if (user.services.includes('affiliate-portal, ')) user.services = user.services.replace('affiliate-portal', ''); const updated = yield this.authService.updateUser(user); return Promise.resolve(updated &amp;&amp; updated.response); }); } /** * @desc Change a Facilitator's role to the role specified by &lt;code&gt;roleId&lt;/code&gt;. If a role exists that belongs to the Affiliate Portal, it is removed first * * @param {string} extId - Facilitator's Contact Id * @param {any} roleId - Id of the role to change to * @returns {Promise&lt;boolean&gt;} * @memberof FacilitatorsService */ changeRole(extId, roleId) { return __awaiter(this, void 0, void 0, function* () { const user = yield this.authService.getUser(`user.extId='${extId}'`); if (user === undefined) return Promise.reject({ error: 'USER_NOT_FOUND' }); const currentRole = user.roles.filter(role =&gt; { return role.service === 'affiliate-portal'; })[0]; const set = { userEmail: user.email, roleId }; if (currentRole !== undefined) { yield this.authService.removeRoleFromUser({ userEmail: user.email, roleId: currentRole.id }); } const added = yield this.authService.addRoleToUser(set); return Promise.resolve(added &amp;&amp; added.response); }); } }; FacilitatorsService = __decorate([ common_1.Component(), __param(0, common_1.Inject('SalesforceService')), __param(1, common_1.Inject('AuthService')), __param(2, common_1.Inject('CacheService')), __param(3, common_1.Inject('LoggerService')), __metadata(&quot;design:paramtypes&quot;, [_1.SalesforceService, _1.AuthService, _1.CacheService, _1.LoggerService]) ], FacilitatorsService); exports.FacilitatorsService = FacilitatorsService; × Search results Close "},"initService.js.html":{"id":"initService.js.html","title":"Source: initService.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: initService.js &quot;use strict&quot;; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const components_1 = require(&quot;./components&quot;); const _ = require(&quot;lodash&quot;); const authService = new components_1.AuthService(); const log = new components_1.LoggerService(); /** * This class handles lifting the server. It checks for required roles (creates them if not found) and stores the requried global ids * * @export * @class InitService */ class InitService { static init() { return __awaiter(this, void 0, void 0, function* () { log.info('Initializing Affiliate Portal...'); const roles = (yield authService.getRoles('role.service=\\'affiliate-portal\\'')).roles; const facilitator = roles.filter(role =&gt; { return role.name === 'Facilitator'; }); const affiliateManager = roles.filter(role =&gt; { return role.name === 'Affiliate Manager'; }); if (!facilitator.length) { const role = yield authService.createRole({ name: 'Facilitator', service: 'affiliate-portal' }); log.info('Created Facilitator role! %j', role); global['facilitatorId'] = role.id; } else { log.info('Found Facilitator role: %j', _.omit(facilitator[0], ['users', 'permissions'])); global['facilitatorId'] = facilitator[0].id; } if (!affiliateManager.length) { const role = yield authService.createRole({ name: 'Affiliate Manager', service: 'affiliate-portal' }); log.info('Created Affiliate Manager role! %j', role); global['affiliateManagerId'] = role.id; } else { log.info('Found Affiliate Manager role: %j', _.omit(affiliateManager[0], ['users', 'permissions'])); global['affiliateManagerId'] = affiliateManager[0].id; } return Promise.resolve(); }); } } exports.InitService = InitService; × Search results Close "},"middleware_isAfMan.middleware.js.html":{"id":"middleware_isAfMan.middleware.js.html","title":"Source: middleware/isAfMan.middleware.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: middleware/isAfMan.middleware.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../components&quot;); /** * This middleware checks if the current session's user has the role of Affiliate Manager * * @export * @class IsAFManMiddleware * @implements {NestMiddleware} */ let IsAFManMiddleware = class IsAFManMiddleware { constructor() { this.log = new components_1.LoggerService(); } /** * The function called when the middleware is activated. Checks that &lt;code&gt;req.session.user.role === 'Affiliate Manager'&lt;/code&gt; * * @returns {void} * @memberof IsAFManMiddleware */ resolve() { return (req, res, next) =&gt; { const isAFMan = req.session.user &amp;&amp; req.session.user.role.name === 'Affiliate Manager'; this.log.debug('Is AF Man %j', isAFMan); if (isAFMan) return next(); return res.status(common_1.HttpStatus.FORBIDDEN).json({ error: 'ACCESS_FORBIDDEN' }); }; } }; IsAFManMiddleware = __decorate([ common_1.Middleware(), __metadata(&quot;design:paramtypes&quot;, []) ], IsAFManMiddleware); exports.IsAFManMiddleware = IsAFManMiddleware; × Search results Close "},"middleware_isValid.middleware.js.html":{"id":"middleware_isValid.middleware.js.html","title":"Source: middleware/isValid.middleware.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: middleware/isValid.middleware.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../components&quot;); const _ = require(&quot;lodash&quot;); /** * This middleware checks if the user with given JWT is valid (JWT is correct and hasn't expired) and rebuilds the user object on session if it is missing * * @export * @class IsValidMiddleware * @implements {NestMiddleware} */ let IsValidMiddleware = class IsValidMiddleware { constructor() { this.sfService = new components_1.SalesforceService(); this.authService = new components_1.AuthService(); this.log = new components_1.LoggerService(); } /** * The function called when the middleware is activated. If &lt;code&gt;req.session.user === undefined&lt;/code&gt; this method gets the user with matching JWT from the Auth database, then fetches the user's Contact from Salesforce and merges the two objects * * @returns {void} * @memberof IsValidMiddleware */ resolve() { return (req, res, next) =&gt; { if (req.path === '/workshops' &amp;&amp; (req.query.isPublic || req.headers['x-is-public'])) return next(); if (!req.headers['x-jwt'] &amp;&amp; !req.session.user) return res.status(common_1.HttpStatus.BAD_REQUEST).json({ error: 'HEADER_NOT_SET', header: 'x-jwt' }); return this.authService.isValid(req.headers['x-jwt'] || req.session.user.jwt) .then(valid =&gt; { if (valid &amp;&amp; !valid.response) throw { error: 'ACCESS_FORBIDDEN' }; if (req.session.user &amp;&amp; req.session.user.jwt === req.headers['x-jwt']) throw new Error('SESSION_ALIVE'); return this.authService.getUser(`user.jwt='${req.headers['x-jwt']}'`); }) .then(user =&gt; { if (user === undefined) throw { error: 'USER_NOT_FOUND' }; req.session.user = _.omit(user, ['password', 'roles']); req.session.user.role = user.roles.map(role =&gt; { if (role.service === 'affiliate-portal') return _.omit(role, ['users', 'service']); })[0]; const query = { action: 'SELECT', fields: [ 'Id', 'Name', 'FirstName', 'LastName', 'AccountId', 'Email' ], table: 'Contact', clauses: `Email='${user.email}' AND RecordType.Name='Affiliate Instructor'` }; return this.sfService.query(query); }) .then(response =&gt; { let contact = response.records[0]; req.session.user = _.merge(contact, _.omit(req.session.user, ['email'])); req.session.affiliate = contact['AccountId']; return next(); }) .catch(error =&gt; { if (error.message === 'SESSION_ALIVE') return next(); if (error.metadata) error = components_1.SalesforceService.parseRPCErrorMeta(error); this.log.error('Error in is-valid.middleware.ts: %j', error); return res.status(common_1.HttpStatus.FORBIDDEN).json(error); }); }; } }; IsValidMiddleware = __decorate([ common_1.Middleware(), __metadata(&quot;design:paramtypes&quot;, []) ], IsValidMiddleware); exports.IsValidMiddleware = IsValidMiddleware; × Search results Close "},"components_logger_logger.component.js.html":{"id":"components_logger_logger.component.js.html","title":"Source: components/logger/logger.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/logger/logger.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const winston_1 = require(&quot;winston&quot;); const path = require(&quot;path&quot;); /** * Provides an abstraction of the [Winston](https://github.com/winstonjs/winston) JS logger. Uses Console and File transports. * * @export * @class LoggerService */ let LoggerService = class LoggerService { constructor() { let logPath = process.env.LOG_PATH || ''; let logName = process.env.LOG_FILE || 'affiliates-api.log'; let logLevel = process.env.LOG_LEVEL || 'silly'; const logTransports = [ new winston_1.transports.Console({ colorize: true, prettyPrint: true, timestamp: true }), new winston_1.transports.File({ filename: path.join(logPath, logName), json: false, prettyPrint: true }) ]; const logOptions = { transports: logTransports, level: logLevel }; this.logger = new winston_1.Logger(logOptions); } /** * The log function is multipurpse * * @param {Level} level - NPM Logging levels (&lt;code&gt;'error' | 'warn' | 'info' | 'verbose' | 'debug' | 'silly'&lt;/code&gt;) * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ log(level, message, meta) { return this.logger.log(level, message, meta); } /** * Logs a &lt;code&gt;'silly'&lt;/code&gt; level message. Used for temporary log messages. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ silly(message, meta) { return this.logger.silly(message, meta); } /** * Logs a &lt;code&gt;'debug'&lt;/code&gt; level message. Used for more permanent messages that shouldn't make it to production. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ debug(message, meta) { return this.logger.debug(message, meta); } /** * Logs a &lt;code&gt;'verbose'&lt;/code&gt; level message. Used for permanent messages that may or may not be filtered in production. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ verbose(message, meta) { return this.logger.verbose(message, meta); } /** * Logs a &lt;code&gt;'info'&lt;/code&gt; level message. Used for permanent messages that will be logged in production. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ info(message, meta) { return this.logger.info(message, meta); } /** * Logs a &lt;code&gt;'warn'&lt;/code&gt; level message. Used for permanent messages to alert developers of potential bugs or issues. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ warn(message, meta) { return this.logger.warn(message, meta); } /** * Logs a &lt;code&gt;'error'&lt;/code&gt; level message. Used for permanent messages to alert developers of unexpected state or application failure. * * @param {string} message - The message to print. May include one formatting operator (i.e. 'my object: %j') * @param {any} [meta] - The value to insert into message with formatting operator * @returns {LoggerInstance} * @memberof LoggerService */ error(message, meta) { return this.logger.error(message, meta); } }; LoggerService = __decorate([ common_1.Component(), __metadata(&quot;design:paramtypes&quot;, []) ], LoggerService); exports.LoggerService = LoggerService; × Search results Close "},"middleware_routeLogger.middleware.js.html":{"id":"middleware_routeLogger.middleware.js.html","title":"Source: middleware/routeLogger.middleware.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: middleware/routeLogger.middleware.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../components&quot;); const _ = require(&quot;lodash&quot;); /** * Route Logger logs information about every route. Use this to debug any issues. * * @export * @class RouteLoggerMiddleware * @implements {NestMiddleware} */ let RouteLoggerMiddleware = class RouteLoggerMiddleware { constructor() { this.log = new components_1.LoggerService(); } /** * The function called when the middleware is activated. Logs:&lt;br&gt;&lt;br&gt; &lt;code&gt;METHOD /original/url [by user.email]&lt;br&gt;&amp;emsp;Header: 'x-custom-header: value'&lt;br&gt;&amp;emsp;Body: {&quot;some&quot;:&quot;field&quot;}&lt;/code&gt; * * @returns {void} * @memberof RouteLoggerMiddleware */ resolve() { return (req, res, next) =&gt; { // Log route info let info = `${req.method} ${req.originalUrl}` + (req.session.user ? ` by ${req.session.user.email}` : ''); this.log.verbose(info); // Log custom headers for (const key in req.headers) { if (key.includes('x-')) this.log.verbose(`\\tHeader: '${key}: ${req.headers[key]}'`); } // Log post body if (req.method === 'POST' || req.method === 'PUT') { let body = process.env.NODE_ENV === 'production' ? _.omit(req.body, ['password']) : req.body; this.log.verbose('\\tBody: %j', req.body); } return next(); }; } }; RouteLoggerMiddleware = __decorate([ common_1.Middleware(), __metadata(&quot;design:paramtypes&quot;, []) ], RouteLoggerMiddleware); exports.RouteLoggerMiddleware = RouteLoggerMiddleware; × Search results Close "},"components_salesforce_salesforce.component.js.html":{"id":"components_salesforce_salesforce.component.js.html","title":"Source: components/salesforce/salesforce.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/salesforce/salesforce.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const grpc = require(&quot;grpc&quot;); const path = require(&quot;path&quot;); const bluebird = require(&quot;bluebird&quot;); const sfservices = grpc.load(path.join(__dirname, '../../../proto/sf_services.proto')).sfservices; /** * @desc A service to abastract the Shingo SF Microservice client * * @export * @class SalesforceService */ let SalesforceService = class SalesforceService { constructor() { this.client = bluebird.promisifyAll(this.getClient()); } /** * @desc Method to instantiate a RPC Client from the sf_services.proto * * @private * @returns Returns a RPC Client to be used in consuming the Shingo SF Microservice * @memberof SalesforceService */ getClient() { return new sfservices.SalesforceMicroservices(`${process.env.SF_API}:80`, grpc.credentials.createInsecure()); } /** * @desc Async wrapper for the Shingo SF Microservice query call * * @param {SFQueryObject} query - See {@link SFQueryObject} * @returns {Promise&lt;SFQueryResponse&gt;} See {@link SFQueryResponse} * @memberof SalesforceService */ query(query) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.queryAsync(query); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice retrieve call * * @param {SFIdData} data - See {@link SFIdData} * @returns {Promise&lt;object&gt;} * @memberof SalesforceService */ retrieve(data) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.retrieveAsync(data); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice create call * * @param {SFRecordData} data - See {@link SFRecordData} * @returns {Promise&lt;SFSuccessObject[]&gt;} - See {@link SFSuccessObject} * @memberof SalesforceService */ create(data) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.createAsync(data); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice update call * * @param {SFRecordData} data - See {@link SFRecordData} * @returns {Promise&lt;SFSuccessObject[]&gt;} - See {@link SFSuccessObject} * @memberof SalesforceService */ update(data) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.updateAsync(data); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice delete call * * @param {SFIdData} data - See {@link SFIdData} * @returns {Promise&lt;SFSuccessObject[]&gt;} - See {@link SFSuccessObject} * @memberof SalesforceService */ delete(data) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.deleteAsync(data); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice describe call * * @param {string} object - SF Object to describe * @returns {Promise&lt;object&gt;} - See {@linkhttps://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/dome_sobject_describe.htm|Salesforce Docs} * @memberof SalesforceService */ describe(object) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.describeAsync({ object }); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Async wrapper for the Shingo SF Microservice search call * * @param {SFSearchData} data - See {@link SFSearchData} * @returns {Promise&lt;SFSearchResults&gt;} - Array of workshops * @memberof SalesforceService */ search(data) { return __awaiter(this, void 0, void 0, function* () { const response = yield this.client.searchAsync(data); return Promise.resolve(JSON.parse(response.contents)); }); } /** * @desc Utility method to assist in parsing gRPC error metadata. Returns a JSON object from the parsed error data. If no JSON object can be parsed, the method attempts to return the 'error-bin' from the meta-data as a string. If that fails the method returns the error passed to it. * * @static * @param {gRPCError} error - The error to be parsed * @returns {object} The parsed error, 'error-bin'.toString(), or passed in error * @memberof SalesforceService */ static parseRPCErrorMeta(error) { try { let err = JSON.parse(error.metadata.get('error-bin').toString()); return err; } catch (caught) { if (error.metadata.get('error-bin')) return error.metadata.get('error-bin').toString(); else return error; } } }; SalesforceService = __decorate([ common_1.Component(), __metadata(&quot;design:paramtypes&quot;, []) ], SalesforceService); exports.SalesforceService = SalesforceService; × Search results Close "},"components_user_user.component.js.html":{"id":"components_user_user.component.js.html","title":"Source: components/user/user.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/user/user.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); /** * @desc Provide methods for working with users * * @export * @class UserService */ let UserService = class UserService { /** * @desc Parse out the workshops that a user has permissions for * * @param {any} user - Requires &lt;code&gt;user.permissions[]&lt;/code&gt; and &lt;code&gt;user.roles[].permissions[]&lt;/code&gt; * @returns {string[]} * @memberof UserService */ getWorkshopIds(user) { let ids = []; user.permissions.forEach(p =&gt; { if (p.resource.includes('/workshops/')) ids.push(`'${p.resource.replace('/workshops/', '')}'`); }); user.role.permissions.forEach(p =&gt; { if (p.resource.includes('/workshops/')) ids.push(`'${p.resource.replace('/workshops/', '')}'`); }); return [...new Set(ids)]; // Only return unique ids } }; UserService = __decorate([ common_1.Component() ], UserService); exports.UserService = UserService; × Search results Close "},"controllers_workshops_workshops.controller.js.html":{"id":"controllers_workshops_workshops.controller.js.html","title":"Source: controllers/workshops/workshops.controller.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: controllers/workshops/workshops.controller.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const components_1 = require(&quot;../../components&quot;); const factories_1 = require(&quot;../../factories&quot;); const base_controller_1 = require(&quot;../base.controller&quot;); const objKeyValidator_1 = require(&quot;../../validators/objKeyValidator&quot;); /** * @desc Controller of the REST API logic for Workshops * * @export * @class WorkshopsController * @extends {BaseController} */ let WorkshopsController = class WorkshopsController extends base_controller_1.BaseController { constructor(workshopsService, multer, logger) { super(logger); this.workshopsService = workshopsService; this.multer = multer; } ; /** * @desc &lt;h5&gt;GET: /workshops&lt;/h5&gt; Calls {@link WorkshopsService#getAll} to get an array of Workshops * * @param {Session} session - Session contains the current user. The function uses the permissions on this object to query Salesforce for the workshops. * @param {any} isPublicQ - Query parameter &lt;code&gt;'isPublic'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Alias &lt;code&gt;headers['x-force-refesh']&lt;/code&gt;; Returns public workshops * @param {any} isPublicH - Header &lt;code&gt;'x-is-public'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Alias &lt;code&gt;query['isPublic']&lt;/code&gt;; Returns public workshops * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body contains a JSON array of Workshops * @memberof WorkshopsController */ readAll(res, session, isPublicQ, isPublicH, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { const isPublic = (isPublicQ === 'true' || isPublicH === 'true'); const forceRefresh = refresh === 'true'; if (!session.user &amp;&amp; !isPublic) return this.handleError(res, 'Error in WorkshopsController.readAll(): ', { error: &quot;SESSION_EXPIRED&quot; }, common_1.HttpStatus.FORBIDDEN); try { const workshops = yield this.workshopsService.getAll(isPublic, forceRefresh, session.user); return res.status(common_1.HttpStatus.OK).json(workshops); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.readAll(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /workshops/describe&lt;/h5&gt; Calls {@link WorkshopsService#describe} to describe Workshop\\__c * * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body is a JSON object with the describe result * @memberof WorkshopsController */ describe(res, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { try { const describeObject = yield this.workshopsService.describe(refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(describeObject); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.describe(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /workshops/search&lt;/h5&gt; Calls {@link WorkshopsService#search}. Returns an array of workshops that match search criteria * * * @param {Header} search - Header &lt;code&gt;'x-search'&lt;/code&gt;. SOSL search expression (i.e. '*Discover Test*'). * @param {Header} retrieve - Header &lt;code&gt;'x-retrieve'&lt;/code&gt;. A comma seperated list of the Workshop\\__c fields to retrieve (i.e. 'Id, Name, Start_Date\\__c') * @param {Header} [refresh='false'] - Header &lt;code&gt;'x-force-refresh'&lt;/code&gt;; Expected values &lt;code&gt;[ 'true', 'false' ]&lt;/code&gt;; Forces cache refresh * @returns {Promise&lt;Response&gt;} Response body is a JSON Array of workshops * @memberof WorkshopsController */ search(res, search, retrieve, refresh = 'false') { return __awaiter(this, void 0, void 0, function* () { // Check for required fields if (!search || !retrieve) return this.handleError(res, 'Error in WorkshopsController.search(): ', { error: 'MISSING_PARAMETERS', params: (!search &amp;&amp; !retrieve ? ['search', 'retrieve '] : !search ? ['search'] : ['retrieve']) }, common_1.HttpStatus.BAD_REQUEST); try { const workshops = yield this.workshopsService.search(search, retrieve, refresh === 'true'); return res.status(common_1.HttpStatus.OK).json(workshops); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.search(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /workshops/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link WorkshopsService#get} to retrieve a specific workshop * * @param {SalesforceId} id - Workshop\\__c id. match &lt;code&gt;/a[\\w\\d]{14,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response body is a JSON object of type {&lt;em&gt;returned fields&lt;/em&gt;} * @memberof WorkshopsController */ read(res, id) { return __awaiter(this, void 0, void 0, function* () { // Check the id if (!id.match(/a[\\w\\d]{14,17}/)) return this.handleError(res, 'Error in WorkshopsController.read(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const workshop = yield this.workshopsService.get(id); this.log.debug(`GET: /workshops/${id} =&gt; %j`, workshop); return res.status(common_1.HttpStatus.OK).json(workshop); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.read(): ', error); } }); } /** * @desc &lt;h5&gt;GET: /workshops/&lt;em&gt;:id&lt;/em&gt;/facilitators&lt;/h5&gt; Calls {@link WorkshopsService#facilitators} to get all associated facilitators for a workshop * * @param {SalesforceId} id - Workshop\\__cid. match &lt;code&gt;/a[\\w\\d]{14,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response is a JSON Array of Contact objects * @memberof WorkshopsController */ facilitators(res, id) { return __awaiter(this, void 0, void 0, function* () { // Check the id if (!id.match(/a[\\w\\d]{14,17}/)) return this.handleError(res, 'Error in WorkshopsController.facilitators(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const facilitators = yield this.workshopsService.facilitators(id); return res.status(common_1.HttpStatus.OK).json(facilitators); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.facilitators(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /workshops&lt;/h5&gt; Calls {@link WorkshopsService#create} to create a new workshop in Salesforce and permissions for the workshop in the Shingo Auth API * &lt;br&gt;&lt;br&gt; * NOTE: &lt;code&gt;&quot;facilitators&quot;&lt;/code&gt; is exptected to be of type &lt;code&gt;[{&quot;Id&quot;, &quot;Email&quot;}]&lt;/code&gt;. Where &lt;code&gt;&quot;Id&quot;&lt;/code&gt; is a Salesforce Contact Id. * @param {Body} body - Required fields &lt;code&gt;[ &quot;Name&quot;, &quot;Organizing_Affiliate\\__c&quot;, &quot;Start_Date\\__c&quot;, &quot;End_Date\\__c&quot;, &quot;Host_Site\\__c&quot;, &quot;Event_Country\\__c&quot;, &quot;Event_City\\__c&quot;, &quot;facilitators&quot; ]&lt;/code&gt; * @param {Session} session - Accesses the affiliate id from the session to compare to the Organizaing_Affiliate\\__c on the body * @returns {Promise&lt;Response&gt;} Response is a JSON Object from the resulting Salesforce operation * @memberof WorkshopsController */ create(res, body, session) { return __awaiter(this, void 0, void 0, function* () { // Check required parameters this.log.debug('Trying to create workshop:\\n%j', body); let valid = objKeyValidator_1.checkRequired(body, ['Organizing_Affiliate__c', 'Start_Date__c', 'End_Date__c', 'Host_Site__c', 'Event_Country__c', 'Event_City__c', 'facilitators']); if (!valid.valid) return this.handleError(res, 'Error in WorkshopsController.create(): ', { error: 'MISSING_FIELD', fields: valid.missing }, common_1.HttpStatus.BAD_REQUEST); // Check for valid SF ID on Organizing_Affiliate\\__c if (!body.Organizing_Affiliate__c.match(/[\\w\\d]{15,17}/)) return this.handleError(res, 'Error in WorkshopsController.create(): ', { error: 'INVALID_SF_ID', message: `${body.Organizing_Affiliate__c} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); // Check can create for Organizing_Affiliate\\__c if (session.user.role.name !== 'Affiliate Manager' &amp;&amp; session.affiliate !== body.Organizing_Affiliate__c) return this.handleError(res, 'Error in WorkshopsController.create(): ', { error: 'PERM_DENIDED', message: `You are not allowed to post workshops for the Affiliate with Id ${body.Organizing_Affiliate__c}` }, common_1.HttpStatus.FORBIDDEN); try { const sfSuccess = yield this.workshopsService.create(body); return res.status(common_1.HttpStatus.CREATED).json(sfSuccess); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.create(): ', error); } }); } /** * @desc &lt;h5&gt;PUT: /workshops/&lt;em&gt;:id&lt;/em&gt;&lt;/h5&gt; Calls {@link WorkshopsService#update} to update a workshop's fields. This function also updates facilitator associations and permissions * * @param {Body} body - Required fields &lt;code&gt;[ &quot;Id&quot;, &quot;Organizing_Affiliate\\__c&quot; ]&lt;/code&gt; * @param {Session} session - Accesses the affiliate id from the session to compare to the Organizaing_Affiliate\\__c on the body * @param {SalesforceId} id - Workshop\\__c id. match &lt;code&gt;/a[\\w\\d]{14,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response is a JSON Object from the resulting Salesforce operation * @memberof WorkshopsController */ update(res, id, body, session) { return __awaiter(this, void 0, void 0, function* () { // Check required parameters let required = objKeyValidator_1.checkRequired(body, ['Id', 'Organizing_Affiliate__c']); if (!required.valid) return this.handleError(res, 'Error in WorkshopsController.update(): ', { error: 'MISSING_FIELD', fields: required.missing }, common_1.HttpStatus.BAD_REQUEST); // Check the id const pattern = /[\\w\\d]{15,18}/; if (!pattern.test(id) || !pattern.test(body.Id) || id !== body.Id || !pattern.test(body.Organizing_Affiliate__c)) return this.handleError(res, 'Error in WorkshopsController.update(): ', { error: 'INVALID_SF_ID', message: `${body.Organizing_Affiliate__c} or ${id} or ${body.Id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); // Check can update for Organizing_Affiliate\\__c if (session.user.role.name !== 'Affiliate Manager' &amp;&amp; session.affiliate !== body.Organizing_Affiliate__c) return this.handleError(res, 'Error in WorkshopsController.update(): ', { error: 'PERM_DENIDED', message: `You are not allowed to update workshops for the Affiliate with Id ${body.Organizing_Affiliate__c}` }, common_1.HttpStatus.FORBIDDEN); try { const result = yield this.workshopsService.update(body); return res.status(common_1.HttpStatus.OK).json(result); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.update(): ', error); } }); } /** * @desc &lt;h5&gt;POST: /workshops/&lt;em&gt;:id&lt;/em&gt;/attendee_file&lt;/h5&gt; Calls {@link WorkshopsService#upload} to upload a file (containing the Attendee List) as an attachment to the Workshop\\__c record in Salesforce * &lt;br&gt;NOTE: Expecting attached file to be in the field attendeeList and &lt;= 25MB in size * @param {SalesforceId} id - The record Id of the Workshop to attach the file to * @returns {Promise&lt;Response&gt;} * @memberof WorkshopsController */ uploadAttendeeFile(req, res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/a[\\w\\d]{14,17}/)) return this.handleError(res, 'Error in WorkshopsController.uploadAttendeeFile(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); const upload = this.multer.getUploadFunction('attendeeList'); return upload(req, res, error =&gt; { if (error) return this.handleError(res, 'Error in WorkshopsController.uploadAttendeeFile(): ', error); try { const ext = req.file.originalname.split('.').pop(); this.workshopsService.upload(id, `attendee_list.${ext}`, [req.file.buffer.toString('base64')]); return res.status(common_1.HttpStatus.ACCEPTED).json(); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.uploadAttendeeFile(): ', error); } }); }); } /** * @desc &lt;h5&gt;POST: /workshops/&lt;em&gt;:id&lt;/em&gt;/evaluation_files&lt;/h5&gt; Calls {@link WorkshopsService#upload} to upload an array of files (containing workshop evaluations) as attachments to the Workshop\\__c record in Salesforce * * @param {SalesforceId} id - The record Id of the Workshop to attach the files to * @returns {Promise&lt;Response&gt;} * @memberof WorkshopsController */ uploadEvaluations(req, res, id) { return __awaiter(this, void 0, void 0, function* () { if (!id.match(/a[\\w\\d]{14,17}/)) return this.handleError(res, 'Error in WorkshopsController.uploadEvaluations(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); const upload = this.multer.getUploadFunction('evaluationFiles', 'array'); return upload(req, res, error =&gt; { if (error) return this.handleError(res, 'Error in WorkshopsController.uploadEvaluations(): ', error); const files = req.files.map(file =&gt; { return file.buffer.toString('base64'); }); const ext = req.files[0].originalname.split('.').pop(); try { this.workshopsService.upload(id, `evaluation.${ext}`, files); return res.status(common_1.HttpStatus.ACCEPTED).json(); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.uploadEvaluations(): ', error); } }); }); } /** * @desc &lt;h5&gt;DELETE: /workshops/&lt;em&gt;:id&lt;/eM&gt;&lt;/h5&gt; Calls {@link WorkshopsService#delete} to delete the workshop given by &lt;em&gt;:id&lt;/em&gt; * * @param {SalesforceId} id - Workshop\\__c id. match &lt;code&gt;/a[\\w\\d]{14,17}/&lt;/code&gt; * @returns {Promise&lt;Response&gt;} Response is a JSON Object from the resulting Salesforce operation * @memberof WorkshopsController */ delete(res, id) { return __awaiter(this, void 0, void 0, function* () { // Check the id if (!id.match(/a[\\w\\d]{14,17}/)) return this.handleError(res, 'Error in WorkshopsController.delete(): ', { error: 'INVALID_SF_ID', message: `${id} is not a valid Salesforce ID.` }, common_1.HttpStatus.BAD_REQUEST); try { const result = yield this.workshopsService.delete(id); return res.status(common_1.HttpStatus.OK).json(result); } catch (error) { return this.handleError(res, 'Error in WorkshopsController.delete(): ', error); } }); } }; __decorate([ common_1.Get(), __param(0, common_1.Response()), __param(1, common_1.Session()), __param(2, common_1.Query('isPublic')), __param(3, common_1.Headers('x-is-public')), __param(4, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;readAll&quot;, null); __decorate([ common_1.Get('/describe'), __param(0, common_1.Response()), __param(1, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;describe&quot;, null); __decorate([ common_1.Get('/search'), __param(0, common_1.Response()), __param(1, common_1.Headers('x-search')), __param(2, common_1.Headers('x-retrieve')), __param(3, common_1.Headers('x-force-refresh')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;search&quot;, null); __decorate([ common_1.Get('/:id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;read&quot;, null); __decorate([ common_1.Get('/:id/facilitators'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;facilitators&quot;, null); __decorate([ common_1.Post(), __param(0, common_1.Response()), __param(1, common_1.Body()), __param(2, common_1.Session()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;create&quot;, null); __decorate([ common_1.Put('/:id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __param(2, common_1.Body()), __param(3, common_1.Session()), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;update&quot;, null); __decorate([ common_1.Post('/:id/attendee_file'), __param(0, common_1.Request()), __param(1, common_1.Response()), __param(2, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;uploadAttendeeFile&quot;, null); __decorate([ common_1.Post('/:id/evaluation_files'), __param(0, common_1.Request()), __param(1, common_1.Response()), __param(2, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;uploadEvaluations&quot;, null); __decorate([ common_1.Delete('/:id'), __param(0, common_1.Response()), __param(1, common_1.Param('id')), __metadata(&quot;design:type&quot;, Function), __metadata(&quot;design:paramtypes&quot;, [Object, Object]), __metadata(&quot;design:returntype&quot;, Promise) ], WorkshopsController.prototype, &quot;delete&quot;, null); WorkshopsController = __decorate([ common_1.Controller('workshops'), __metadata(&quot;design:paramtypes&quot;, [components_1.WorkshopsService, factories_1.MulterFactory, components_1.LoggerService]) ], WorkshopsController); exports.WorkshopsController = WorkshopsController; × Search results Close "},"components_workshops_workshops.component.js.html":{"id":"components_workshops_workshops.component.js.html","title":"Source: components/workshops/workshops.component.js","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Source: components/workshops/workshops.component.js &quot;use strict&quot;; var __decorate = (this &amp;&amp; this.__decorate) || function (decorators, target, key, desc) { var c = arguments.length, r = c &lt; 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d; if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.decorate === &quot;function&quot;) r = Reflect.decorate(decorators, target, key, desc); else for (var i = decorators.length - 1; i &gt;= 0; i--) if (d = decorators[i]) r = (c &lt; 3 ? d(r) : c &gt; 3 ? d(target, key, r) : d(target, key)) || r; return c &gt; 3 &amp;&amp; r &amp;&amp; Object.defineProperty(target, key, r), r; }; var __metadata = (this &amp;&amp; this.__metadata) || function (k, v) { if (typeof Reflect === &quot;object&quot; &amp;&amp; typeof Reflect.metadata === &quot;function&quot;) return Reflect.metadata(k, v); }; var __param = (this &amp;&amp; this.__param) || function (paramIndex, decorator) { return function (target, key) { decorator(target, key, paramIndex); } }; var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) { return new (P || (P = Promise))(function (resolve, reject) { function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } } function rejected(value) { try { step(generator[&quot;throw&quot;](value)); } catch (e) { reject(e); } } function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); } step((generator = generator.apply(thisArg, _arguments || [])).next()); }); }; Object.defineProperty(exports, &quot;__esModule&quot;, { value: true }); const common_1 = require(&quot;@nestjs/common&quot;); const _1 = require(&quot;../&quot;); const lodash_1 = require(&quot;lodash&quot;); /** * @desc A service to provide functions for working with Workshops * * @export * @class WorkshopsService */ let WorkshopsService = class WorkshopsService { constructor(sfService = new _1.SalesforceService(), authService = new _1.AuthService(), cache = new _1.CacheService(), userService = new _1.UserService(), log = new _1.LoggerService()) { this.sfService = sfService; this.authService = authService; this.cache = cache; this.userService = userService; this.log = log; } /** * @desc Get all workshops that the current session's user has permissions for (or all publicly listed workshps). The function assembles a list of workshop ids form the users permissions to query Salesforce. The queried fields from Salesforce are as follows:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;&quot;Id&quot;,&lt;br&gt; * &amp;emsp;&quot;Name&quot;,&lt;br&gt; * &amp;emsp;&quot;Start_Date\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;End_Date\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Course_Manager\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Billing_Contact\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Event_City\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Event_Country\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Organizing_Affiliate\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Public\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Registration_Website\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Status\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Host_Site\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Workshop_Type\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Language\\__c&quot;&lt;br&gt; * ]&lt;/code&gt;&lt;br&gt;&lt;br&gt; * The query is ordered by &lt;em&gt;'Start_Date\\__c'&lt;/em&gt;. * * @param {boolean} [isPublic=false] - Get Only public workshops (skips permission check) * @param {boolean} [refresh=false] - Force the refresh of the cache * @param {any} [user] - The user to filter permissions for (&lt;code&gt;isPublic === false&lt;/code&gt;); user needs permissions[] and roles[].permissions[] * @returns {Promise&lt;Workshop[]&gt;} * @memberof WorkshopsService */ getAll(isPublic = false, refresh = false, user) { return __awaiter(this, void 0, void 0, function* () { const query = { action: 'SELECT', fields: [ &quot;Id&quot;, &quot;Name&quot;, &quot;Start_Date__c&quot;, &quot;End_Date__c&quot;, &quot;Course_Manager__c&quot;, &quot;Billing_Contact__c&quot;, &quot;Event_City__c&quot;, &quot;Event_Country__c&quot;, &quot;Organizing_Affiliate__c&quot;, &quot;Public__c&quot;, &quot;Registration_Website__c&quot;, &quot;Status__c&quot;, &quot;Host_Site__c&quot;, &quot;Workshop_Type__c&quot;, &quot;Language__c&quot; ], table: &quot;Workshop__c&quot;, clauses: &quot;Public__c=true AND Status__c='Verified' ORDER BY Start_Date__c&quot; }; if (!isPublic) { const ids = this.userService.getWorkshopIds(user); if (ids.length === 0) return Promise.resolve([]); query.clauses = `Id IN (${ids.join()}) ORDER BY Start_Date__c`; } if (!this.cache.isCached(query) || refresh) { let workshops = (yield this.sfService.query(query)).records; if (isPublic) this.cache.cache(query, workshops); return Promise.resolve(workshops); } else { return Promise.resolve(this.cache.getCache(query)); } }); } /** * @desc Get a specific workshop by Salesforce ID. Retrieves all fields of the Workshop\\__c object. Specifically:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;&quot;Id&quot;,&lt;br&gt; * &amp;emsp;&quot;IsDeleted&quot; ,&lt;br&gt; * &amp;emsp;&quot;Name&quot;,&lt;br&gt; * &amp;emsp;&quot;CreatedDate&quot;,&lt;br&gt; * &amp;emsp;&quot;CreatedById&quot;,&lt;br&gt; * &amp;emsp;&quot;LastModifiedDate&quot;,&lt;br&gt; * &amp;emsp;&quot;LastModifiedById&quot;,&lt;br&gt; * &amp;emsp;&quot;SystemModstamp&quot;,&lt;br&gt; * &amp;emsp;&quot;LastViewedDate&quot;,&lt;br&gt; * &amp;emsp;&quot;LastReferencedDate&quot;,&lt;br&gt; * &amp;emsp;&quot;Billing_Contact\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Course_Manager\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;End_Date\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Event_City\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Event_Country\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Organizing_Affiliate\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Public\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Registration_Website\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Start_Date\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Status\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Workshop_Type\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Host_Site\\__c&quot;,&lt;br&gt; * &amp;emsp;&quot;Language\\__c&quot;,&lt;br&gt; * ]&lt;/code&gt; * * @param {string} id - A Salesforce ID corresponding to a Workshop\\__c record * @returns {Promise&lt;Workshop&gt;} * @memberof WorkshopsService */ get(id) { return __awaiter(this, void 0, void 0, function* () { // Create the data parameter for the RPC call let workshop = (yield this.sfService.retrieve({ object: 'Workshop__c', ids: [id] }))[0]; workshop.facilitators = (yield this.facilitators(id)).map(f =&gt; f['Instructor__r']) || []; workshop.Course_Manager__r = (yield this.sfService.retrieve({ object: 'Contact', ids: [workshop.Course_Manager__c] }))[0]; this.log.debug('got cm: %j', workshop.Course_Manager__r); this.log.debug(`getting workshop ${id} =&gt; %j`, workshop); return Promise.resolve(workshop); }); } /** * @desc Uses the Salesforce REST API to describe the Workshop\\__c object. See the Salesforce documentation for more about 'describe'. * * @param {boolean} [refresh=false] - Force the refresh of the cache * @returns {Promise&lt;any&gt;} * @memberof WorkshopsService */ describe(refresh = false) { return __awaiter(this, void 0, void 0, function* () { // Set the key for the cache const key = 'describeWorkshops'; // If no cached result, use the shingo-sf-api to get the result if (!this.cache.isCached(key) || refresh) { const describeObject = yield this.sfService.describe('Workshop__c'); // Cache describe this.cache.cache(key, describeObject); return Promise.resolve(describeObject); } else { return Promise.resolve(this.cache.getCache(key)); } }); } /** * @desc Executes a SOSL query to search for text on workshop records in Salesforce. Example response body:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;a1Sg0000001jXbgEAE&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Workshop 10 (Updated)&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Start_Date\\__c&quot;: &quot;2017-07-12&quot;&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;a1Sg0000001jXWgEAM&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Workshop 9 (Updated)&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Start_Date\\__c&quot;: &quot;2017-07-11&quot;&lt;br&gt; * &amp;emsp;},&lt;br&gt; * &amp;emsp;{&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Id&quot;: &quot;a1Sg0000001jXWbEAM&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Name&quot;: &quot;Test Workshop 8&quot;,&lt;br&gt; * &amp;emsp;&amp;emsp;&quot;Start_Date\\__c&quot;: &quot;2017-07-11&quot;&lt;br&gt; * &amp;emsp;}&lt;br&gt; * ]&lt;/code&gt; * * @param {Header} search - SOSL search expression (i.e. '*Discover Test*') * @param {Header} retrieve - A comma seperated list of the Workshop\\__c fields to retrieve (i.e. 'Id, Name, Start_Date\\__c') * @param {Header} [refresh='false'] - Used to force the refresh of the cache * @returns {Promise&lt;Workshop[]&gt;} * @memberof WorkshopsService */ search(search, retrieve, refresh = false) { return __awaiter(this, void 0, void 0, function* () { // Generate the data parameter for the RPC call const data = { search: `{${search}}`, retrieve: `Workshop__c(${retrieve})` }; // If no cached result, use the shingo-sf-api to get result if (!this.cache.isCached(data) || refresh) { const workshops = (yield this.sfService.search(data)).searchRecords || []; // Cache results this.cache.cache(data, workshops); return Promise.resolve(workshops); } else { return Promise.resolve(this.cache.getCache(data)); } }); } /** * @desc Get the associated instructors for the workshop with id given in the param &lt;em&gt;:id&lt;/em&gt;. Queried fields are as follows:&lt;br&gt;&lt;br&gt; * &lt;code&gt;[&lt;br&gt; * &amp;emsp;&quot;Instructor\\__r.FirstName&quot;,&lt;br&gt; * &amp;emsp;&quot;Instructor\\__r.LastName&quot;,&lt;br&gt; * &amp;emsp;&quot;Instructor\\__r.Email&quot;,&lt;br&gt; * &amp;emsp;&quot;Instructor\\__r.Title&quot;&lt;br&gt; * ]&lt;/code&gt; * * @param {string} id - A Salesforce ID corresponding to a Workshop\\__c record * @returns {Promise&lt;object[]&gt;} * @memberof WorkshopsService */ facilitators(id) { return __awaiter(this, void 0, void 0, function* () { let query = { action: &quot;SELECT&quot;, fields: [ &quot;Id&quot;, &quot;Instructor__r.Id&quot;, &quot;Instructor__r.FirstName&quot;, &quot;Instructor__r.LastName&quot;, &quot;Instructor__r.Name&quot;, &quot;Instructor__r.AccountId&quot;, &quot;Instructor__r.Email&quot;, &quot;Instructor__r.Title&quot; ], table: &quot;WorkshopFacilitatorAssociation__c&quot;, clauses: `Workshop__c='${id}'` }; const facilitators = (yield this.sfService.query(query)).records || []; const ids = facilitators.map(fac =&gt; `'${fac.Id}'`); const auths = (yield this.authService.getUsers(`user.extId IN (${ids.join()})`)).users; for (let fac of facilitators) { let auth = auths.filter(auth =&gt; auth.extId === fac.Id)[0]; if (auth) fac.id = auth.id; } this.log.debug('Got facilitators =&gt; %j', facilitators); return Promise.resolve(facilitators); }); } /** * @desc Creates a new workshop in Salesforce and creates permissions for the workshop in the Shingo Auth API. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {Workshop} workshop - The workshop to be created. Requires &lt;code&gt;[ 'Name', 'Start_Date\\__c', 'End_Date\\__c', 'Organizing_Affiliate\\__c' ] * @returns {Promise&lt;any&gt;} * @memberof WorkshopsService */ create(workshop) { return __awaiter(this, void 0, void 0, function* () { // Use the shingo-sf-api to create the new record const data = { object: 'Workshop__c', records: [{ contents: JSON.stringify(lodash_1._.omit(workshop, ['facilitators'])) }] }; const result = (yield this.sfService.create(data))[0]; workshop.Id = result.id; yield this.grantPermissions(workshop); return Promise.resolve(result); }); } /** * @desc Updates a workshop's fields. This function also will get the instructor associations with the given workshop to update associations and permissions. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {Workshop} workshop * @returns {Promise&lt;any&gt;} * @memberof WorkshopsService */ update(workshop) { return __awaiter(this, void 0, void 0, function* () { // Use the shingo-sf-api to create the new record const data = { object: 'Workshop__c', records: [{ contents: JSON.stringify(lodash_1._.omit(workshop, ['facilitators'])) }] }; this.log.debug('updating sf with: %j', data); const result = (yield this.sfService.update(data))[0]; const currFacilitators = yield this.facilitators(workshop.Id); const removeFacilitators = lodash_1._.differenceWith(currFacilitators, workshop.facilitators, (val, other) =&gt; { return other &amp;&amp; val.Id === other.Id; }); workshop.facilitators = lodash_1._.differenceWith(workshop.facilitators, currFacilitators, (val, other) =&gt; { return other &amp;&amp; val.Id === other.Id; }); this.log.debug('removeFacilitators: %j', removeFacilitators); this.log.debug('addFacilitators: %j', workshop.facilitators); yield this.grantPermissions(workshop); this.log.debug('granted new permissions'); yield this.removePermissions(workshop, removeFacilitators); this.log.debug('returning result: %j', result); return Promise.resolve(result); }); } /** * @desc Upload a file(s) as an attachment to the specified record * * @param {SalesforceId} id - Id of the record to attach file to * @param {string} fileName - The name of the file * * @param {string[]} files - The files to attach (base 64) * @returns {Promise&lt;SFSuccessObject[]&gt;} * @memberof WorkshopsService */ upload(id, fileName, files) { return __awaiter(this, void 0, void 0, function* () { const records = []; let fileId = 0; for (const file of files) { records.push({ contents: JSON.stringify({ ParentId: id, Name: `${fileId++}-${fileName}`, Body: file }) }); } const data = { object: 'Attachment', records }; const result = yield this.sfService.create(data); return Promise.resolve(result); }); } /** * @desc Deletes the workshop given by &lt;em&gt;:id&lt;/em&gt; in Salesforce and removes the permission in the Auth API. Returns the following:&lt;br&gt;&lt;br&gt; * &lt;code&gt;{&lt;br&gt; * &amp;emsp;&quot;id&quot;: SalesforceId,&lt;br&gt; * &amp;emsp;&quot;success&quot;: boolean,&lt;br&gt; * &amp;emsp;&quot;errors&quot;: []&lt;br&gt; * }&lt;/code&gt; * * @param {string} id * @returns {Promise&lt;any&gt;} * @memberof WorkshopsService */ delete(id) { return __awaiter(this, void 0, void 0, function* () { // Create the data parameter for the RPC call const data = { object: 'Workshop__c', ids: [id] }; const result = (yield this.sfService.delete(data))[0]; for (const level of [0, 1, 2]) yield this.authService.deletePermission(`/workshops/${id}`, level); return Promise.resolve(result); }); } /** * @desc Helper method to grant permissions to the appropraite roles and users in the Auth API. * * @private * @param {Workshop} workshop - Requires [ 'Id', 'facilitators' ] * @returns {Promise&lt;void&gt;} * @memberof WorkshopsService */ grantPermissions(workshop) { return __awaiter(this, void 0, void 0, function* () { const roles = (yield this.authService.getRoles(`role.name=\\'Affiliate Manager\\' OR role.name='Course Manager -- ${workshop.Organizing_Affiliate__c}'`)).roles; const resource = `/workshops/${workshop.Id}`; for (const role of roles) { yield this.authService.grantPermissionToRole(resource, 2, role.id); } for (const facilitator of workshop.facilitators) { const data = { object: 'WorkshopFacilitatorAssociation__c', records: [{ contents: JSON.stringify({ Workshop__c: workshop.Id, Instructor__c: facilitator['Id'] }) }] }; yield this.sfService.create(data); yield this.authService.grantPermissionToUser(resource, 2, facilitator['id']); } return Promise.resolve(); }); } /** * @desc Helper method to remove permissions from deleted facilitators * * @private * @param {Workshop} workshop - Requires [ 'Id', 'facilitators' ] * @param {any[]} remove - Requires [ 'Id', 'Email' ] * @returns {Promise&lt;void&gt;} * @memberof WorkshopsService */ removePermissions(workshop, remove) { return __awaiter(this, void 0, void 0, function* () { const resource = `/workshops/${workshop.Id}`; const ids = remove.map(facilitator =&gt; { return facilitator.Id; }); yield this.sfService.delete({ object: 'WorkshopFacilitatorAssociation__c', ids }); const instructors = remove.map(facilitator =&gt; { return `'${facilitator.Instructor__r.Id}'`; }); if (!instructors.length) return Promise.resolve(); const users = yield this.authService.getUsers(`user.extId IN (${instructors.join()})`); for (const user in users) { yield this.authService.revokePermissionFromUser(resource, 2, user['id']); } return Promise.resolve(); }); } }; WorkshopsService = __decorate([ common_1.Component(), __param(0, common_1.Inject('SalesforceService')), __param(1, common_1.Inject('AuthService')), __param(2, common_1.Inject('CacheService')), __param(3, common_1.Inject('UserService')), __param(4, common_1.Inject('LoggerService')), __metadata(&quot;design:paramtypes&quot;, [_1.SalesforceService, _1.AuthService, _1.CacheService, _1.UserService, _1.LoggerService]) ], WorkshopsService); exports.WorkshopsService = WorkshopsService; × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Classes Classes AffiliatesController AffiliatesService ApplicationModule AuthController AuthMiddleware AuthService BaseController CacheService FacilitatorsController FacilitatorsService InitService IsAFManMiddleware IsValidMiddleware LoggerService RouteLoggerMiddleware SalesforceService UserService WorkshopsController WorkshopsService × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Shingo Affiliate Portal APIIntroductionThis project aims to provide REST services to the Shingo Affiliate Portal. Services provided are authentication, CRUD operations for Workhops, CRUD operations for Facilitators, and CRUD operations for Affiliates. External DepedanciesThe Shingo Affiliate Portal API consumes the Shingo SF Microservice and the Shingo Auth Microservice. ReferenceWorkshops GET: /workshops GET: /workshops/:id -- Protected by IsValidMiddleware and AuthMiddleware GET: /workshops/:id/facilitators -- Protected by IsValidMiddleware and AuthMiddleware GET: /workshops/describe -- Protected by IsValidMiddleware GET: /workshops/search -- Protected by IsValidMiddleware POST: /workshops -- Protected by IsValidMiddleware and AuthMiddleware PUT: /workshops/:id -- Protected by IsValidMiddleware and AuthMiddleware DELETE: /workshops/:id -- Protected by IsValidMiddleware and AuthMiddleware Facilitators GET: /facilitators -- Protected by IsValidMiddleware and AuthMiddleware GET: /facilitators/:id -- Protected by IsValidMiddleware and AuthMiddleware GET: /facilitators/describe -- Protected by IsValidMiddleware and AuthMiddleware GET: /facilitators/search -- Protected by IsValidMiddleware and AuthMiddleware POST: /facilitators -- Protected by IsValidMiddleware and IsAFManMiddleware POST: /facilitators/:id/roles/:roleId -- Protected by IsValidMiddleware and IsAFManMiddleware PUT: /facilitators/:id -- Protected by IsValidMiddleware and IsAFManMiddleware DELETE: /facilitators/:id -- Protected by IsValidMiddleware and IsAFManMiddleware DELETE: /facilitators/:id/login -- Protected by IsValidMiddleware and IsAFManMiddleware DELETE: /facilitators/:id/unamp -- Protected by IsValidMiddleware and IsAFManMiddleware Affiliates GET: /affiliates GET: /affiliates/:id -- Protected by IsValidMiddleware and AuthMiddleware GET: /affiliates/:id/coursemanagers -- Protected by IsValidMiddleware and AuthMiddleware GET: /affiliates/describe -- Protected by IsValidMiddleware and IsAFManMiddleware GET: /affiliates/search -- Protected by IsValidMiddleware and IsAFManMiddleware POST: /affiliates -- Protected by IsValidMiddleware and IsAFManMiddleware POST: /affiliates/:id/map -- Protected by IsValidMiddleware and IsAFManMiddleware PUT: /affiliates/:id -- Protected by IsValidMiddleware and IsAFManMiddleware DELETE: /affiliates/:id -- Protected by IsValidMiddleware and IsAFManMiddleware Auth POST: /auth/login POST: /auth/valid -- Protected by IsValidMiddleware GET: /auth/logout -- Protected by IsValidMiddleware × Search results Close "},"AffiliatesController.html":{"id":"AffiliatesController.html","title":"Class: AffiliatesController","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: AffiliatesController AffiliatesController new AffiliatesController() Controller of the REST API logic for Affiliates Source: controllers/affiliates/affiliates.controller.js, line 27 Extends BaseController Methods create(body) POST: /affiliates Calls AffiliatesService#create to create a new Affiliate Parameters: Name Type Description body Body Required fields [ &quot;Name&quot; ] Source: controllers/affiliates/affiliates.controller.js, line 157 Returns: Type Promise.&lt;Response&gt; delete(id) DELETE: /affiliates/:id Calls AffiliatesService#delete to &quot;delete&quot; an Affiliate Parameters: Name Type Description id SalesforceId Account id. match /[\\w\\d]{15,17}/ Source: controllers/affiliates/affiliates.controller.js, line 222 Returns: Type Promise.&lt;Response&gt; describe( [refresh]) GET: /affiliates/describe Calls AffiliatesService#describe to describe the Account Object Parameters: Name Type Argument Default Description refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/affiliates/affiliates.controller.js, line 71 Returns: Type Promise.&lt;Response&gt; handleError(res, message, error [, errorCode]) A helper function to return an error response to the client. Parameters: Name Type Argument Default Description res Response The express response from the calling route message string Log message error * An error object to be logged and returned as JSON errorCode HttpStatus &lt;optional&gt; HttpStatus.INTERNAL_SERVER_ERROR HttpStatus CODE Inherited From: BaseController#handleError Source: controllers/base.controller.js, line 38 Returns: Response body is a JSON object with the error map(id) POST: /affiliates/:id/map Calls AffiliatesService#map to create permissions for a Licensed Affiliate Account Parameters: Name Type Description id SalesforceId Account id. match /[\\w\\d]{15,17}/ Source: controllers/affiliates/affiliates.controller.js, line 178 Returns: Type Promise.&lt;Response&gt; read(id) GET: /affiliates/:id Calls AffiliatesService#get to retrieve a specific affiliate Parameters: Name Type Description id SalesforceId Account id. match /[\\w\\d]{15,17}/ Source: controllers/affiliates/affiliates.controller.js, line 137 Returns: Type Promise.&lt;Response&gt; readAll(isPublicQ, isPublicH [, refresh]) GET: /affiliates Calls AffiliatesService#getAll to get a list of affiliates Parameters: Name Type Argument Default Description isPublicQ Query Query parameter 'isPublic'; Expected values [ 'true', 'false' ]; Alias headers['x-force-refesh']; Returns public affiliates isPublicH Header Header 'x-is-public'; Expected values [ 'true', 'false' ]; Alias query['isPublic']; Returns public affiliates refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/affiliates/affiliates.controller.js, line 49 Returns: Type Promise.&lt;Response&gt; search(search, retrieve [, refresh]) GET: /affiliates/search Calls AffiliatesService#search. Returns an array of affiliates that match search criteria Parameters: Name Type Argument Default Description search Header Header 'x-search'. SOSL search expression (i.e. 'Test'). retrieve Header Header 'x-retrieve'. A comma seperated list of the Account fields to retrieve (i.e. 'Id, Name') refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/affiliates/affiliates.controller.js, line 91 Returns: Type Promise.&lt;Response&gt; searchCMS(id, search, retrieve [, refresh]) Search the related contacts of an Affiliate. Calls AffiliatesService#searchCM to retrieve a list of contacts Parameters: Name Type Argument Default Description id SalesforceId The Salesforce Id of the affiliate search Header Header 'x-search'. SOSL search expression (i.e. 'User*'). retrieve Header Header 'x-retrieve'. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name') refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/affiliates/affiliates.controller.js, line 115 Returns: Type Promise.&lt;Response&gt; update(body, id) PUT: /affiliates/:id Calls AffiliatesService#update to update an Affiliate Parameters: Name Type Description body Body Required fields [ &quot;Id&quot; ] id SalesforceId Account id. match /[\\w\\d]{15,17}/ Source: controllers/affiliates/affiliates.controller.js, line 199 Returns: Type Promise.&lt;Response&gt; × Search results Close "},"AffiliatesService.html":{"id":"AffiliatesService.html","title":"Class: AffiliatesService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: AffiliatesService AffiliatesService new AffiliatesService() A service to provide functions for working with Affiliates Source: components/affiliates/affiliates.component.js, line 25 Methods create(affiliate) Creates a new Account of record type 'Licensed Affiliate' in Salesforce and corresponding permissions and roles. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description affiliate Affiliate Affiliate to create Source: components/affiliates/affiliates.component.js, line 199 Returns: Type Promise.&lt;any&gt; delete(id) Removes all permissions, roles, and user logins associated with the Affiliate. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description id string Salesforce Id of the Account to &quot;delete&quot; Source: components/affiliates/affiliates.component.js, line 266 Returns: Type Promise.&lt;any&gt; describe( [refresh]) Uses the Salesforce REST API to describe the Account object. See the Salesforce documentation for more about 'describe' Parameters: Name Type Argument Default Description refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/affiliates/affiliates.component.js, line 107 Returns: Type Promise.&lt;any&gt; get(id) Get the facilitator with the id passed at the parameter :id. The following fields are returned: [ TODO: Add fields that are returned ] Parameters: Name Type Description id string Salesforce ID for an Account Source: components/affiliates/affiliates.component.js, line 94 Returns: Type Promise.&lt;Affiliate&gt; getAll( [isPublic] [, refresh]) Get all AFfiliates (minus McKinsey if isPublic). Queries the following fields: [ &quot;Id&quot;, &quot;Name&quot;, &quot;Summaryc&quot;, &quot;Logoc&quot;, &quot;Page_Pathc&quot;, &quot;Website&quot;, &quot;Languagesc&quot; ] Parameters: Name Type Argument Default Description isPublic boolean &lt;optional&gt; false Filter out private Affiliates refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/affiliates/affiliates.component.js, line 55 Returns: Type Promise.&lt;Array.&lt;Affiliate&gt;&gt; map(id) Create the corresponding permissions and roles for the Affiliate in the Shingo Auth API. Parameters: Name Type Description id string Affiliate's Account Id Source: components/affiliates/affiliates.component.js, line 219 Returns: Type Promise.&lt;any&gt; search(search, retrieve [, refresh]) Executes a SOSL query to search for text on Accounts of record type Licensed Affiliate. Example response body: [ { &quot;Id&quot;: &quot;003g000001VvwEZAAZ&quot;, &quot;Name&quot;: &quot;Test One&quot;, }, { &quot;Id&quot;: &quot;003g000001VvwEZABA&quot;, &quot;Name&quot;: &quot;Test Two&quot;, }, { &quot;Id&quot;: &quot;003g000001VvwEZABB&quot;, &quot;Name&quot;: &quot;Test Three&quot;, }, ] Parameters: Name Type Argument Default Description search Header Header 'x-search'. SOSL search expression (i.e. 'Test'). retrieve Header Header 'x-retrieve'. A comma seperated list of the Account fields to retrieve (i.e. 'Id, Name') refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/affiliates/affiliates.component.js, line 146 Returns: Type Promise.&lt;Array.&lt;Affiliate&gt;&gt; update(affiliate) Updates an Affiliate's fields: Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description affiliate Affiliate Affiliate's fields to update Source: components/affiliates/affiliates.component.js, line 243 Returns: Type Promise.&lt;SFSuccessObject&gt; × Search results Close "},"ApplicationModule.html":{"id":"ApplicationModule.html","title":"Class: ApplicationModule","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: ApplicationModule ApplicationModule new ApplicationModule() The NestJS application module ties together the controllers and components. It also configures any nest middleware. Source: app.module.js, line 14 × Search results Close "},"AuthController.html":{"id":"AuthController.html","title":"Class: AuthController","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: AuthController AuthController new AuthController() Provides the controller of the Auth REST logic Source: controllers/auth/auth.controller.js, line 27 Extends BaseController Methods handleError(res, message, error [, errorCode]) A helper function to return an error response to the client. Parameters: Name Type Argument Default Description res Response The express response from the calling route message string Log message error * An error object to be logged and returned as JSON errorCode HttpStatus &lt;optional&gt; HttpStatus.INTERNAL_SERVER_ERROR HttpStatus CODE Inherited From: BaseController#handleError Source: controllers/base.controller.js, line 38 Returns: Response body is a JSON object with the error login(body) POST: /auth/login Calls AuthService#login and SalesforceService#query to login a user Parameters: Name Type Description body any Required fields: [ 'email', 'password' ] Source: controllers/auth/auth.controller.js, line 48 Returns: Response body is an object with the user's JWT Type Promise.&lt;Response&gt; logout() GET: /auth/logout Calls AuthService#updateUser to set the user's JWT to '' and removes the user from the session Source: controllers/auth/auth.controller.js, line 101 Returns: Type Promise.&lt;Response&gt; valid() GET: /auth/valid Protected by isValid middleware. Returns the user's JWT Source: controllers/auth/auth.controller.js, line 90 Returns: Type Promise.&lt;Response&gt; × Search results Close "},"AuthMiddleware.html":{"id":"AuthMiddleware.html","title":"Class: AuthMiddleware","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: AuthMiddleware AuthMiddleware new AuthMiddleware() The auth middleware uses the Shingo Auth API to test if the user has permissions to access a given resource Implements: NestMiddleware Source: middleware/auth.middleware.js, line 14 Methods resolve(level [, resource]) The function called when the middleware is activated. Calls AuthService#canAccess. NOTE: If user is an Affiliate Manager all check logic is skipped as the user implicitly has all permissions. Parameters: Name Type Argument Description level 1 | 2 The level of permissions required (1=Read,2=Write) resource string &lt;optional&gt; The resource being accessed Source: middleware/auth.middleware.js, line 34 Returns: Type void × Search results Close "},"AuthService.html":{"id":"AuthService.html","title":"Class: AuthService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: AuthService AuthService new AuthService() A service to abastract the Shingo Auth Microservice client Source: components/auth/auth.component.js, line 17 Methods addRoleToUser(set) Add a role to a user by email Parameters: Name Type Description set RoleRequest User and Role to associate Source: components/auth/auth.component.js, line 94 Returns: Type Promise.&lt;any&gt; canAccess(resource, level, jwt) Check if user with JWT can access the requested resource with given permission level Parameters: Name Type Description resource string Resource to grant permissions to level 1 | 2 Level of access (1=Read,2=Write) jwt string User's JWT Source: components/auth/auth.component.js, line 285 Returns: Type Promise.&lt;any&gt; createPermission(permission) Create a permission. Parameters: Name Type Description permission Permission Permission to be created Source: components/auth/auth.component.js, line 134 Returns: Type Promise.&lt;any&gt; createRole(role) Create a role Parameters: Name Type Description role Role Role to create Source: components/auth/auth.component.js, line 185 Returns: Type Promise.&lt;any&gt; createUser(user) Create a user in the Auth Database Parameters: Name Type Description user User Expecting {&quot;email&quot;, &quot;password&quot;, &quot;services&quot;, &quot;extId?&quot;} Source: components/auth/auth.component.js, line 64 Returns: Type Promise.&lt;any&gt; deletePermission(resource, level) Delete a permission Parameters: Name Type Description resource string Permission resource level 0 | 1 | 2 Permission level Source: components/auth/auth.component.js, line 155 Returns: Type Promise.&lt;any&gt; deleteRole(role) Delete a role Parameters: Name Type Description role Role Id of role to delete Source: components/auth/auth.component.js, line 205 Returns: Type Promise.&lt;any&gt; deleteUser(user) Delete a user from the Auth Database Parameters: Name Type Description user User User to delete Source: components/auth/auth.component.js, line 84 Returns: Type Promise.&lt;any&gt; getPermission(clause) Get a single permission based on a TypeORM Query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 124 Returns: Type Promise.&lt;any&gt; getPermissions(clause) Get an array of permissions based on TypeORM query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 114 Returns: Type Promise.&lt;any&gt; getRole(clause) Get a single role based on a TypeORM query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 175 Returns: Type Promise.&lt;any&gt; getRoles(clause) Get an array of roles based on a TypeORM query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 165 Returns: Type Promise.&lt;any&gt; getUser(clause) Get a single user based upon a TypeORM query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 54 Returns: Type Promise.&lt;any&gt; getUsers(clause) Get an array of users based upon a TypeORM query Parameters: Name Type Description clause string A TypeORM query. See here for some examples Source: components/auth/auth.component.js, line 44 Returns: Type Promise.&lt;any&gt; grantPermissionToRole(resource, level, roleId) Grant permission to a role based on resource and level Parameters: Name Type Description resource string Resource to grant permissions to level 0 | 1 | 2 Level to grant (0=Deny,1=Read,2=Write) roleId number Role's Id Source: components/auth/auth.component.js, line 229 Returns: Type Promise.&lt;any&gt; grantPermissionToUser(resource, level, userId) Grant permission to a user based on resource and level Parameters: Name Type Description resource string Resource to grant permissions to level 0 | 1 | 2 Level to grant (0=Deny,1=Read,2=Write) userId number User's Id Source: components/auth/auth.component.js, line 217 Returns: Type Promise.&lt;any&gt; isValid(token) Check if JWT is valid Parameters: Name Type Description token string JWT Source: components/auth/auth.component.js, line 273 Returns: Type Promise.&lt;any&gt; login(creds) Use email and password to login a user Parameters: Name Type Description creds Credentials Source: components/auth/auth.component.js, line 263 Returns: Type Promise.&lt;any&gt; removeRoleFromUser(set) Remove a role from a user by email Parameters: Name Type Description set RoleRequest User and Role to disassociate Source: components/auth/auth.component.js, line 104 Returns: Type Promise.&lt;any&gt; revokePermissionFromRole(resource, level, roleId) Revoke permission from a role based on resource and level Parameters: Name Type Description resource string Resource to grant permissions to level 0 | 1 | 2 Level to grant (0=Deny,1=Read,2=Write) roleId number Role's Id Source: components/auth/auth.component.js, line 253 Returns: Type Promise.&lt;any&gt; revokePermissionFromUser(resource, level, userId) Revoke permission from a user based on resource and level Parameters: Name Type Description resource string Resource to grant permissions to level 0 | 1 | 2 Level to grant (0=Deny,1=Read,2=Write) userId number User's Id Source: components/auth/auth.component.js, line 241 Returns: Type Promise.&lt;any&gt; updatePermission(permission) Update a permission Parameters: Name Type Description permission Permission Permission to update Source: components/auth/auth.component.js, line 144 Returns: Type Promise.&lt;any&gt; updateRole(role) Update a role Parameters: Name Type Description role Role Role to update Source: components/auth/auth.component.js, line 195 Returns: Type Promise.&lt;any&gt; updateUser(user) Update a user in the Auth Database Parameters: Name Type Description user User Expecting {oneormoreof: {&quot;email&quot;, &quot;password&quot;, &quot;services&quot;}, oneof: {&quot;id&quot;, extId&quot;}} Source: components/auth/auth.component.js, line 74 Returns: Type Promise.&lt;any&gt; × Search results Close "},"BaseController.html":{"id":"BaseController.html","title":"Class: BaseController","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: BaseController BaseController new BaseController() The base controller class contains methods shared between multiple routes Source: controllers/base.controller.js, line 17 Methods handleError(res, message, error [, errorCode]) A helper function to return an error response to the client. Parameters: Name Type Argument Default Description res Response The express response from the calling route message string Log message error * An error object to be logged and returned as JSON errorCode HttpStatus &lt;optional&gt; HttpStatus.INTERNAL_SERVER_ERROR HttpStatus CODE Source: controllers/base.controller.js, line 38 Returns: Response body is a JSON object with the error × Search results Close "},"CacheService.html":{"id":"CacheService.html","title":"Class: CacheService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: CacheService CacheService new CacheService() A service that provides an in-memory cache Source: components/cache/cache.component.js, line 19 Methods cache(obj, value) Caches the value based on the resulting key. Logs error if not successfully. Parameters: Name Type Description obj object | string value * Source: components/cache/cache.component.js, line 74 getCache(obj) Get the cached result for the give key Parameters: Name Type Description obj object | string Source: components/cache/cache.component.js, line 48 Returns: The cached result. 'undefined' if key is not found. isCached(obj) Checks if cache contains key Parameters: Name Type Description obj object | string Source: components/cache/cache.component.js, line 61 Returns: Type boolean × Search results Close "},"FacilitatorsController.html":{"id":"FacilitatorsController.html","title":"Class: FacilitatorsController","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: FacilitatorsController FacilitatorsController new FacilitatorsController() Controller of the REST API logic for Facilitators Source: controllers/facilitators/facilitators.controller.js, line 27 Extends BaseController Methods changeRole(id, roleId) POST: /facilitators/:id/roles/:roleId Calls FacilitatorsService#changeRole to change a Facilitator's role Parameters: Name Type Description id SalesforceId Contact id. match /[\\w\\d]{15,17}/ roleId number Id of the role to change too Source: controllers/facilitators/facilitators.controller.js, line 272 Returns: Response body is result of add Type Promise.&lt;Response&gt; create(body) POST: /facilitators Calls FacilitatorsService#create to create a new Facilitator Parameters: Name Type Description body Body Required fields: [ 'AccountId', 'FirstName', 'LastName', 'Email', 'password' ]Optional fields: [ 'roleId' ] Source: controllers/facilitators/facilitators.controller.js, line 135 Returns: Response body is a JSON object. Type Promise.&lt;Response&gt; delete(id [, deleteAuth]) DELETE: /facilitators/:id Calls FacilitatorsService#delete, FacilitatorsService#deleteAuth or FacilitatorsService#unmapAuth to remove a facilitator from the affiliate portal Parameters: Name Type Argument Default Description id SalesforceId Contact id. match /[\\w\\d]{15,17}/ deleteAuth string &lt;optional&gt; 'true' Delete auth as well Source: controllers/facilitators/facilitators.controller.js, line 206 Returns: Response is status of deletes and resulting SF Operation Type Promise.&lt;Response&gt; deleteLogin(id) DELETE: /facilitators/:id/login Calls FacilitatorsService#deleteAuth to delete a Facilitator's login only Parameters: Name Type Description id SalesforceId Contact id. match /[\\w\\d]{15,17}/ Source: controllers/facilitators/facilitators.controller.js, line 231 Returns: Response body is result of delete Type Promise.&lt;Response&gt; describe( [refresh]) GET: /facilitators/describe Calls FacilitatorsService#describe to describe Contact Parameters: Name Type Argument Default Description refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/facilitators/facilitators.controller.js, line 69 Returns: Response body is a JSON object with the describe result Type Promise.&lt;Response&gt; handleError(res, message, error [, errorCode]) A helper function to return an error response to the client. Parameters: Name Type Argument Default Description res Response The express response from the calling route message string Log message error * An error object to be logged and returned as JSON errorCode HttpStatus &lt;optional&gt; HttpStatus.INTERNAL_SERVER_ERROR HttpStatus CODE Inherited From: BaseController#handleError Source: controllers/base.controller.js, line 38 Returns: Response body is a JSON object with the error map(body, id) POST: /facilitators/:id Calls FacilitatorsService#mapContact to map an existing Affiliate Instructor Contact to a new/current Auth login Parameters: Name Type Description body Body Required fields: [ 'AccountId', 'Email', 'password' ]Optional fields: ['roleId'] id SalesforceId SalesforceId of the Contact to map Source: controllers/facilitators/facilitators.controller.js, line 159 Returns: Type Promise.&lt;Response&gt; read(id) GET: /facilitators/:id Calls FacilitatorsService#get to retrieve a Facilitator Parameters: Name Type Description id SalesforceId Contact id. match /[\\w\\d]{15,17}/ Source: controllers/facilitators/facilitators.controller.js, line 114 Returns: Response body is a JSON object of type {returned fields} Type Promise.&lt;Response&gt; readAll( [xAffiliate] [, refresh]) GET: /facilitators Call FacilitatorsService#getAll to get a list of facilitators for given 'x-affiliate' || session.affilaite Parameters: Name Type Argument Default Description xAffiliate Header &lt;optional&gt; '' Header 'x-affiliate' Used by the 'Affiliate Manager' role to specify the affiliate to query facilitators for ('' queries all affiliates). refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/facilitators/facilitators.controller.js, line 48 Returns: Response body is JSON Array of objects of type {queried fields} Type Promise.&lt;Response&gt; search(search, retrieve [, refresh]) GET: /facilitators/search Calls FacilitatorsService#search to search for facilitators Parameters: Name Type Argument Default Description search Header Header 'x-search'. SOSL search expression (i.e. 'Test') retrieve Header Header 'x-retrieve'. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name, Email') refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/facilitators/facilitators.controller.js, line 90 Returns: Response body is a JSON Array of objects of type {retrieve fields} Type Promise.&lt;Response&gt; unamp(id) DELETE: /facilitators/:id/unmap Calls FacilitatorsService#unmapAuth to remove the Affiliate Portal service from a login Parameters: Name Type Description id SalesforceId Contact id. match /[\\w\\d]{15,17}/ Source: controllers/facilitators/facilitators.controller.js, line 251 Returns: Reponse body is result of unmap Type Promise.&lt;Response&gt; update(body, id) PUT: /facilitators/:id Calls FacilitatorsService#update to update a Facilitator. If body contains Email or password the associated auth is also updated. Parameters: Name Type Description body any Required fields { ['Id'], oneof: ['FirstName', 'LastName', 'Email', 'password', 'Biography', etc..] } id SalesforceId Contact id. match /[\\w\\d]{15,17}/ Source: controllers/facilitators/facilitators.controller.js, line 183 Returns: Response body is status of updates and resulting SF Operation Type Promise.&lt;Response&gt; × Search results Close "},"FacilitatorsService.html":{"id":"FacilitatorsService.html","title":"Class: FacilitatorsService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: FacilitatorsService FacilitatorsService new FacilitatorsService() A service to provide functions for working with Facilitators Source: components/facilitators/facilitators.component.js, line 26 Methods changeRole(extId, roleId) Change a Facilitator's role to the role specified by roleId. If a role exists that belongs to the Affiliate Portal, it is removed first Parameters: Name Type Description extId string Facilitator's Contact Id roleId any Id of the role to change to Source: components/facilitators/facilitators.component.js, line 439 Returns: Type Promise.&lt;boolean&gt; create(user) Creates a new Contact of record type 'Affiliate Instructor' in Salesforce and addes a user to the Shingo Auth api. The user create for the Auth API will be assigned the role of roleId (defaults to 'Facilitator'). Returns a response like: { &quot;jwt&quot;: string, &quot;id:&quot; number } Parameters: Name Type Description user any User to create Source: components/facilitators/facilitators.component.js, line 221 Returns: Type Promise.&lt;any&gt; createNewAuth(email, password, roleId, extId) Uses the Shingo Auth API to create a new login Parameters: Name Type Description email string password string roleId number extId string Salesforce Id of the associated contact Source: components/facilitators/facilitators.component.js, line 295 Returns: Type Promise.&lt;any&gt; createOrMapAuth(id, user) Searches for an existing user with the same email. If not found, one is created, else the 'affiliate-portal' service is added and permissions are granted. Parameters: Name Type Description id SalesforceId Salesforce Id of the associated contact user any Source: components/facilitators/facilitators.component.js, line 270 Returns: Type Promise.&lt;any&gt; delete(id) Deletes a facilitator. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description id string Salesforce Id of the Contact to delete Source: components/facilitators/facilitators.component.js, line 385 Returns: Type Promise.&lt;any&gt; deleteAuth(extId) Delete a login from the Shingo Auth API Parameters: Name Type Description extId string Facilitator's Contact Id Source: components/facilitators/facilitators.component.js, line 403 Returns: Type Promise.&lt;boolean&gt; describe( [refresh]) Uses the Salesforce REST API to describe the Contact object. See the Salesforce documentation for more about 'describe' Parameters: Name Type Argument Default Description refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/facilitators/facilitators.component.js, line 108 Returns: Type Promise.&lt;any&gt; get(id) Get the facilitator with the id passed at the parameter :id. The following fields are returned: [ TODO: Add fields that are returned ] Parameters: Name Type Description id string Salesforce ID for a Contact Source: components/facilitators/facilitators.component.js, line 198 Returns: Type Promise.&lt;any&gt; getAll( [refresh] [, affiliate]) Get all facilitators for the affiliate specified. All if affiliate === ''. The queried fields from Salesforce are as follows: [ &quot;Id&quot;, &quot;FirstName&quot;, &quot;LastName&quot;, &quot;Email&quot;, &quot;Title&quot;, &quot;Account.Id&quot;, &quot;Account.Name&quot;, &quot;Facilitator_For__r.Id&quot;, &quot;Facilitator_For__r.Name&quot;, &quot;Photograph__c&quot;, &quot;Biography__c&quot; ] Parameters: Name Type Argument Default Description refresh boolean &lt;optional&gt; false Force the refresh of the cache affiliate string &lt;optional&gt; SF Id of the affiliate to get facilitators for (or '' to get all facilitators) Source: components/facilitators/facilitators.component.js, line 60 Returns: Type Promise.&lt;Array.&lt;any&gt;&gt; mapContact(id, user) Maps an existing Contact record to a new/current login Parameters: Name Type Description id SalesforceId The Salesforce Id of the Contact to map user any Source: components/facilitators/facilitators.component.js, line 242 Returns: Type Promise.&lt;any&gt; mapCurrentAuth(userEmail, roleId, extId) Uses the Shingo Auth API to map a Salesforce contact to a current login Parameters: Name Type Description userEmail string roleId number extId string Salesforce Id of the associated contact Source: components/facilitators/facilitators.component.js, line 311 Returns: Type Promise.&lt;any&gt; search(search, retrieve [, affiliate] [, refresh]) Executes a SOSL query to search for text on Contacts of record type Affiliate Instructor Salesforce. Example response body: [ { &quot;Id&quot;: &quot;003g000001VvwEZAAZ&quot;, &quot;Name&quot;: &quot;Test One&quot;, &quot;Email&quot;: &quot;testone@example.com&quot; }, { &quot;Id&quot;: &quot;003g000001VvwEZABA&quot;, &quot;Name&quot;: &quot;Test Two&quot;, &quot;Email&quot;: &quot;testtwo@example.com&quot; }, { &quot;Id&quot;: &quot;003g000001VvwEZABB&quot;, &quot;Name&quot;: &quot;Test Three&quot;, &quot;Email&quot;: &quot;testthree@example.com&quot; }, ] Parameters: Name Type Argument Default Description search Header Header 'x-search'. SOSL search expression (i.e. 'Test'). retrieve Header Header 'x-retrieve'. A comma seperated list of the Contact fields to retrieve (i.e. 'Id, Name, Email') affiliate string &lt;optional&gt; '' The SF Id to filter results for (or '' for no filter) refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/facilitators/facilitators.component.js, line 148 Returns: Type Promise.&lt;any&gt; unmapAuth(extId) Remove the Affiliate Portal as service for a login Parameters: Name Type Description extId string Facilitator's Contact Id Source: components/facilitators/facilitators.component.js, line 416 Returns: Type Promise.&lt;boolean&gt; update(user) Updates a facilitator's fields. Returns the following: { &quot;record&quot;: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] }, &quot;salesforce&quot;: boolean, &quot;auth&quot;: boolean } Parameters: Name Type Description user any The facilitator's fields to update Source: components/facilitators/facilitators.component.js, line 339 Returns: Type Promise.&lt;any&gt; updateAuth(user, extId) Update the associated login of a facilitator Parameters: Name Type Description user any Facilitator's fields to update extId any Facilitator's Contact ID Source: components/facilitators/facilitators.component.js, line 361 Returns: Type Promise.&lt;boolean&gt; × Search results Close "},"InitService.html":{"id":"InitService.html","title":"Class: InitService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: InitService InitService new InitService() This class handles lifting the server. It checks for required roles (creates them if not found) and stores the requried global ids Source: initService.js, line 15 × Search results Close "},"IsAFManMiddleware.html":{"id":"IsAFManMiddleware.html","title":"Class: IsAFManMiddleware","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: IsAFManMiddleware IsAFManMiddleware new IsAFManMiddleware() This middleware checks if the current session's user has the role of Affiliate Manager Implements: NestMiddleware Source: middleware/isAfMan.middleware.js, line 14 Methods resolve() The function called when the middleware is activated. Checks that req.session.user.role === 'Affiliate Manager' Source: middleware/isAfMan.middleware.js, line 31 Returns: Type void × Search results Close "},"IsValidMiddleware.html":{"id":"IsValidMiddleware.html","title":"Class: IsValidMiddleware","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: IsValidMiddleware IsValidMiddleware new IsValidMiddleware() This middleware checks if the user with given JWT is valid (JWT is correct and hasn't expired) and rebuilds the user object on session if it is missing Implements: NestMiddleware Source: middleware/isValid.middleware.js, line 15 Methods resolve() The function called when the middleware is activated. If req.session.user === undefined this method gets the user with matching JWT from the Auth database, then fetches the user's Contact from Salesforce and merges the two objects Source: middleware/isValid.middleware.js, line 34 Returns: Type void × Search results Close "},"LoggerService.html":{"id":"LoggerService.html","title":"Class: LoggerService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: LoggerService LoggerService new LoggerService() Provides an abstraction of the Winston JS logger. Uses Console and File transports. Source: components/logger/logger.component.js, line 15 Methods debug(message [, meta]) Logs a 'debug' level message. Used for more permanent messages that shouldn't make it to production. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 64 Returns: Type LoggerInstance error(message [, meta]) Logs a 'error' level message. Used for permanent messages to alert developers of unexpected state or application failure. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 108 Returns: Type LoggerInstance info(message [, meta]) Logs a 'info' level message. Used for permanent messages that will be logged in production. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 86 Returns: Type LoggerInstance log(level, message [, meta]) The log function is multipurpse Parameters: Name Type Argument Description level Level NPM Logging levels ('error' | 'warn' | 'info' | 'verbose' | 'debug' | 'silly') message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 42 Returns: Type LoggerInstance silly(message [, meta]) Logs a 'silly' level message. Used for temporary log messages. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 53 Returns: Type LoggerInstance verbose(message [, meta]) Logs a 'verbose' level message. Used for permanent messages that may or may not be filtered in production. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 75 Returns: Type LoggerInstance warn(message [, meta]) Logs a 'warn' level message. Used for permanent messages to alert developers of potential bugs or issues. Parameters: Name Type Argument Description message string The message to print. May include one formatting operator (i.e. 'my object: %j') meta any &lt;optional&gt; The value to insert into message with formatting operator Source: components/logger/logger.component.js, line 97 Returns: Type LoggerInstance × Search results Close "},"RouteLoggerMiddleware.html":{"id":"RouteLoggerMiddleware.html","title":"Class: RouteLoggerMiddleware","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: RouteLoggerMiddleware RouteLoggerMiddleware new RouteLoggerMiddleware() Route Logger logs information about every route. Use this to debug any issues. Implements: NestMiddleware Source: middleware/routeLogger.middleware.js, line 15 Methods resolve() The function called when the middleware is activated. Logs: METHOD /original/url [by user.email] Header: 'x-custom-header: value' Body: {&quot;some&quot;:&quot;field&quot;} Source: middleware/routeLogger.middleware.js, line 32 Returns: Type void × Search results Close "},"SalesforceService.html":{"id":"SalesforceService.html","title":"Class: SalesforceService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: SalesforceService SalesforceService new SalesforceService() A service to abastract the Shingo SF Microservice client Source: components/salesforce/salesforce.component.js, line 25 Methods &lt;static&gt; parseRPCErrorMeta(error) Utility method to assist in parsing gRPC error metadata. Returns a JSON object from the parsed error data. If no JSON object can be parsed, the method attempts to return the 'error-bin' from the meta-data as a string. If that fails the method returns the error passed to it. Parameters: Name Type Description error gRPCError The error to be parsed Source: components/salesforce/salesforce.component.js, line 144 Returns: The parsed error, 'error-bin'.toString(), or passed in error Type object create(data) Async wrapper for the Shingo SF Microservice create call Parameters: Name Type Description data SFRecordData See SFRecordData Source: components/salesforce/salesforce.component.js, line 78 Returns: See SFSuccessObject Type Promise.&lt;Array.&lt;SFSuccessObject&gt;&gt; delete(data) Async wrapper for the Shingo SF Microservice delete call Parameters: Name Type Description data SFIdData See SFIdData Source: components/salesforce/salesforce.component.js, line 104 Returns: See SFSuccessObject Type Promise.&lt;Array.&lt;SFSuccessObject&gt;&gt; describe(object) Async wrapper for the Shingo SF Microservice describe call Parameters: Name Type Description object string SF Object to describe Source: components/salesforce/salesforce.component.js, line 117 Returns: See {@linkhttps://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/dome_sobject_describe.htm|Salesforce Docs} Type Promise.&lt;object&gt; query(query) Async wrapper for the Shingo SF Microservice query call Parameters: Name Type Description query SFQueryObject See SFQueryObject Source: components/salesforce/salesforce.component.js, line 52 Returns: See SFQueryResponse Type Promise.&lt;SFQueryResponse&gt; retrieve(data) Async wrapper for the Shingo SF Microservice retrieve call Parameters: Name Type Description data SFIdData See SFIdData Source: components/salesforce/salesforce.component.js, line 65 Returns: Type Promise.&lt;object&gt; search(data) Async wrapper for the Shingo SF Microservice search call Parameters: Name Type Description data SFSearchData See SFSearchData Source: components/salesforce/salesforce.component.js, line 130 Returns: Array of workshops Type Promise.&lt;SFSearchResults&gt; update(data) Async wrapper for the Shingo SF Microservice update call Parameters: Name Type Description data SFRecordData See SFRecordData Source: components/salesforce/salesforce.component.js, line 91 Returns: See SFSuccessObject Type Promise.&lt;Array.&lt;SFSuccessObject&gt;&gt; × Search results Close "},"UserService.html":{"id":"UserService.html","title":"Class: UserService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: UserService UserService new UserService() Provide methods for working with users Source: components/user/user.component.js, line 10 Methods getWorkshopIds(user) Parse out the workshops that a user has permissions for Parameters: Name Type Description user any Requires user.permissions[] and user.roles[].permissions[] Source: components/user/user.component.js, line 24 Returns: Type Array.&lt;string&gt; × Search results Close "},"WorkshopsController.html":{"id":"WorkshopsController.html","title":"Class: WorkshopsController","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: WorkshopsController WorkshopsController new WorkshopsController() Controller of the REST API logic for Workshops Source: controllers/workshops/workshops.controller.js, line 28 Extends BaseController Methods create(body, session) POST: /workshops Calls WorkshopsService#create to create a new workshop in Salesforce and permissions for the workshop in the Shingo Auth API NOTE: &quot;facilitators&quot; is exptected to be of type [{&quot;Id&quot;, &quot;Email&quot;}]. Where &quot;Id&quot; is a Salesforce Contact Id. Parameters: Name Type Description body Body Required fields [ &quot;Name&quot;, &quot;Organizing_Affiliate__c&quot;, &quot;Start_Date__c&quot;, &quot;End_Date__c&quot;, &quot;Host_Site__c&quot;, &quot;Event_Country__c&quot;, &quot;Event_City__c&quot;, &quot;facilitators&quot; ] session Session Accesses the affiliate id from the session to compare to the Organizaing_Affiliate__c on the body Source: controllers/workshops/workshops.controller.js, line 161 Returns: Response is a JSON Object from the resulting Salesforce operation Type Promise.&lt;Response&gt; delete(id) DELETE: /workshops/:id Calls WorkshopsService#delete to delete the workshop given by :id Parameters: Name Type Description id SalesforceId Workshop__c id. match /a[\\w\\d]{14,17}/ Source: controllers/workshops/workshops.controller.js, line 274 Returns: Response is a JSON Object from the resulting Salesforce operation Type Promise.&lt;Response&gt; describe( [refresh]) GET: /workshops/describe Calls WorkshopsService#describe to describe Workshop__c Parameters: Name Type Argument Default Description refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/workshops/workshops.controller.js, line 74 Returns: Response body is a JSON object with the describe result Type Promise.&lt;Response&gt; facilitators(id) GET: /workshops/:id/facilitators Calls WorkshopsService#facilitators to get all associated facilitators for a workshop Parameters: Name Type Description id SalesforceId Workshop__cid. match /a[\\w\\d]{14,17}/ Source: controllers/workshops/workshops.controller.js, line 138 Returns: Response is a JSON Array of Contact objects Type Promise.&lt;Response&gt; handleError(res, message, error [, errorCode]) A helper function to return an error response to the client. Parameters: Name Type Argument Default Description res Response The express response from the calling route message string Log message error * An error object to be logged and returned as JSON errorCode HttpStatus &lt;optional&gt; HttpStatus.INTERNAL_SERVER_ERROR HttpStatus CODE Inherited From: BaseController#handleError Source: controllers/base.controller.js, line 38 Returns: Response body is a JSON object with the error read(id) GET: /workshops/:id Calls WorkshopsService#get to retrieve a specific workshop Parameters: Name Type Description id SalesforceId Workshop__c id. match /a[\\w\\d]{14,17}/ Source: controllers/workshops/workshops.controller.js, line 116 Returns: Response body is a JSON object of type {returned fields} Type Promise.&lt;Response&gt; readAll(session, isPublicQ, isPublicH [, refresh]) GET: /workshops Calls WorkshopsService#getAll to get an array of Workshops Parameters: Name Type Argument Default Description session Session Session contains the current user. The function uses the permissions on this object to query Salesforce for the workshops. isPublicQ any Query parameter 'isPublic'; Expected values [ 'true', 'false' ]; Alias headers['x-force-refesh']; Returns public workshops isPublicH any Header 'x-is-public'; Expected values [ 'true', 'false' ]; Alias query['isPublic']; Returns public workshops refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/workshops/workshops.controller.js, line 52 Returns: Response body contains a JSON array of Workshops Type Promise.&lt;Response&gt; search(search, retrieve [, refresh]) GET: /workshops/search Calls WorkshopsService#search. Returns an array of workshops that match search criteria Parameters: Name Type Argument Default Description search Header Header 'x-search'. SOSL search expression (i.e. 'Discover Test'). retrieve Header Header 'x-retrieve'. A comma seperated list of the Workshop__c fields to retrieve (i.e. 'Id, Name, Start_Date__c') refresh Header &lt;optional&gt; 'false' Header 'x-force-refresh'; Expected values [ 'true', 'false' ]; Forces cache refresh Source: controllers/workshops/workshops.controller.js, line 95 Returns: Response body is a JSON Array of workshops Type Promise.&lt;Response&gt; update(body, session, id) PUT: /workshops/:id Calls WorkshopsService#update to update a workshop's fields. This function also updates facilitator associations and permissions Parameters: Name Type Description body Body Required fields [ &quot;Id&quot;, &quot;Organizing_Affiliate__c&quot; ] session Session Accesses the affiliate id from the session to compare to the Organizaing_Affiliate__c on the body id SalesforceId Workshop__c id. match /a[\\w\\d]{14,17}/ Source: controllers/workshops/workshops.controller.js, line 192 Returns: Response is a JSON Object from the resulting Salesforce operation Type Promise.&lt;Response&gt; uploadAttendeeFile(id) POST: /workshops/:id/attendee_file Calls WorkshopsService#upload to upload a file (containing the Attendee List) as an attachment to the Workshop__c record in Salesforce NOTE: Expecting attached file to be in the field attendeeList and &lt;= 25MB in size Parameters: Name Type Description id SalesforceId The record Id of the Workshop to attach the file to Source: controllers/workshops/workshops.controller.js, line 221 Returns: Type Promise.&lt;Response&gt; uploadEvaluations(id) POST: /workshops/:id/evaluation_files Calls WorkshopsService#upload to upload an array of files (containing workshop evaluations) as attachments to the Workshop__c record in Salesforce Parameters: Name Type Description id SalesforceId The record Id of the Workshop to attach the files to Source: controllers/workshops/workshops.controller.js, line 247 Returns: Type Promise.&lt;Response&gt; × Search results Close "},"WorkshopsService.html":{"id":"WorkshopsService.html","title":"Class: WorkshopsService","body":" Shingo Affiliate Portal Classes AffiliatesControllerAffiliatesServiceApplicationModuleAuthControllerAuthMiddlewareAuthServiceBaseControllerCacheServiceFacilitatorsControllerFacilitatorsServiceInitServiceIsAFManMiddlewareIsValidMiddlewareLoggerServiceRouteLoggerMiddlewareSalesforceServiceUserServiceWorkshopsControllerWorkshopsService Class: WorkshopsService WorkshopsService new WorkshopsService() A service to provide functions for working with Workshops Source: components/workshops/workshops.component.js, line 26 Methods create(workshop) Creates a new workshop in Salesforce and creates permissions for the workshop in the Shingo Auth API. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description workshop Workshop The workshop to be created. Requires [ 'Name', 'Start_Date__c', 'End_Date__c', 'Organizing_Affiliate__c' ] Source: components/workshops/workshops.component.js, line 273 Returns: Type Promise.&lt;any&gt; delete(id) Deletes the workshop given by :id in Salesforce and removes the permission in the Auth API. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description id string Source: components/workshops/workshops.component.js, line 356 Returns: Type Promise.&lt;any&gt; describe( [refresh]) Uses the Salesforce REST API to describe the Workshop__c object. See the Salesforce documentation for more about 'describe'. Parameters: Name Type Argument Default Description refresh boolean &lt;optional&gt; false Force the refresh of the cache Source: components/workshops/workshops.component.js, line 158 Returns: Type Promise.&lt;any&gt; facilitators(id) Get the associated instructors for the workshop with id given in the param :id. Queried fields are as follows: [ &quot;Instructor__r.FirstName&quot;, &quot;Instructor__r.LastName&quot;, &quot;Instructor__r.Email&quot;, &quot;Instructor__r.Title&quot; ] Parameters: Name Type Description id string A Salesforce ID corresponding to a Workshop__c record Source: components/workshops/workshops.component.js, line 232 Returns: Type Promise.&lt;Array.&lt;object&gt;&gt; get(id) Get a specific workshop by Salesforce ID. Retrieves all fields of the Workshop__c object. Specifically: [ &quot;Id&quot;, &quot;IsDeleted&quot; , &quot;Name&quot;, &quot;CreatedDate&quot;, &quot;CreatedById&quot;, &quot;LastModifiedDate&quot;, &quot;LastModifiedById&quot;, &quot;SystemModstamp&quot;, &quot;LastViewedDate&quot;, &quot;LastReferencedDate&quot;, &quot;Billing_Contact__c&quot;, &quot;Course_Manager__c&quot;, &quot;End_Date__c&quot;, &quot;Event_City__c&quot;, &quot;Event_Country__c&quot;, &quot;Organizing_Affiliate__c&quot;, &quot;Public__c&quot;, &quot;Registration_Website__c&quot;, &quot;Start_Date__c&quot;, &quot;Status__c&quot;, &quot;Workshop_Type__c&quot;, &quot;Host_Site__c&quot;, &quot;Language__c&quot;, ] Parameters: Name Type Description id string A Salesforce ID corresponding to a Workshop__c record Source: components/workshops/workshops.component.js, line 140 Returns: Type Promise.&lt;Workshop&gt; getAll( [isPublic] [, refresh] [, user]) Get all workshops that the current session's user has permissions for (or all publicly listed workshps). The function assembles a list of workshop ids form the users permissions to query Salesforce. The queried fields from Salesforce are as follows: [ &quot;Id&quot;, &quot;Name&quot;, &quot;Start_Date__c&quot;, &quot;End_Date__c&quot;, &quot;Course_Manager__c&quot;, &quot;Billing_Contact__c&quot;, &quot;Event_City__c&quot;, &quot;Event_Country__c&quot;, &quot;Organizing_Affiliate__c&quot;, &quot;Public__c&quot;, &quot;Registration_Website__c&quot;, &quot;Status__c&quot;, &quot;Host_Site__c&quot;, &quot;Workshop_Type__c&quot;, &quot;Language__c&quot; ] The query is ordered by 'Start_Date__c'. Parameters: Name Type Argument Default Description isPublic boolean &lt;optional&gt; false Get Only public workshops (skips permission check) refresh boolean &lt;optional&gt; false Force the refresh of the cache user any &lt;optional&gt; The user to filter permissions for (isPublic === false); user needs permissions[] and roles[].permissions[] Source: components/workshops/workshops.component.js, line 67 Returns: Type Promise.&lt;Array.&lt;Workshop&gt;&gt; search(search, retrieve [, refresh]) Executes a SOSL query to search for text on workshop records in Salesforce. Example response body: [ { &quot;Id&quot;: &quot;a1Sg0000001jXbgEAE&quot;, &quot;Name&quot;: &quot;Test Workshop 10 (Updated)&quot;, &quot;Start_Date__c&quot;: &quot;2017-07-12&quot; }, { &quot;Id&quot;: &quot;a1Sg0000001jXWgEAM&quot;, &quot;Name&quot;: &quot;Test Workshop 9 (Updated)&quot;, &quot;Start_Date__c&quot;: &quot;2017-07-11&quot; }, { &quot;Id&quot;: &quot;a1Sg0000001jXWbEAM&quot;, &quot;Name&quot;: &quot;Test Workshop 8&quot;, &quot;Start_Date__c&quot;: &quot;2017-07-11&quot; } ] Parameters: Name Type Argument Default Description search Header SOSL search expression (i.e. 'Discover Test') retrieve Header A comma seperated list of the Workshop__c fields to retrieve (i.e. 'Id, Name, Start_Date__c') refresh Header &lt;optional&gt; 'false' Used to force the refresh of the cache Source: components/workshops/workshops.component.js, line 200 Returns: Type Promise.&lt;Array.&lt;Workshop&gt;&gt; update(workshop) Updates a workshop's fields. This function also will get the instructor associations with the given workshop to update associations and permissions. Returns the following: { &quot;id&quot;: SalesforceId, &quot;success&quot;: boolean, &quot;errors&quot;: [] } Parameters: Name Type Description workshop Workshop Source: components/workshops/workshops.component.js, line 298 Returns: Type Promise.&lt;any&gt; upload(id, fileName, files) Upload a file(s) as an attachment to the specified record Parameters: Name Type Description id SalesforceId Id of the record to attach file to fileName string The name of the file files Array.&lt;string&gt; The files to attach (base 64) Source: components/workshops/workshops.component.js, line 329 Returns: Type Promise.&lt;Array.&lt;SFSuccessObject&gt;&gt; × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
